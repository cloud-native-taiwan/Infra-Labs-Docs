"use strict";(self.webpackChunknew_infra_labs_docs=self.webpackChunknew_infra_labs_docs||[]).push([[7901],{339:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>o,frontMatter:()=>a,metadata:()=>c,toc:()=>u});var r=s(5893),t=s(1151);const a={description:""},l="Quarkus \u6574\u5408 Vault \u8207 Secrets Store CSI Driver",c={id:"self-paced-labs/vault-secrets-store-csi-with-quarkus/index",title:"Quarkus \u6574\u5408 Vault \u8207 Secrets Store CSI Driver",description:"",source:"@site/docs/self-paced-labs/vault-secrets-store-csi-with-quarkus/index.md",sourceDirName:"self-paced-labs/vault-secrets-store-csi-with-quarkus",slug:"/self-paced-labs/vault-secrets-store-csi-with-quarkus/",permalink:"/docs/self-paced-labs/vault-secrets-store-csi-with-quarkus/",draft:!1,unlisted:!1,editUrl:"https://github.com/cloud-native-taiwan/Infra-Labs-Docs/tree/main/docs/self-paced-labs/vault-secrets-store-csi-with-quarkus/index.md",tags:[],version:"current",frontMatter:{description:""},sidebar:"self_paced_labs",previous:{title:"Helm Chart \u6574\u5408\u4ee5 Quarkus \u70ba\u4f8b",permalink:"/docs/self-paced-labs/quarkus-with-helm-charts/"},next:{title:"\u67b6\u8a2d Promethues \u76e3\u63a7 K8s \u53e2\u96c6\u4e26\u4ee5 exporter \u8490\u96c6\u61c9\u7528\u7a0b\u5f0f metrics",permalink:"/docs/self-paced-labs/prometheus/"}},i={},u=[{value:"\u5efa\u7acb\u74b0\u5883",id:"\u5efa\u7acb\u74b0\u5883",level:2},{value:"Vault \u670d\u52d9",id:"vault-\u670d\u52d9",level:3},{value:"\u5efa\u7f6e Quarkus Kubernetes \u53e2\u96c6",id:"\u5efa\u7f6e-quarkus-kubernetes-\u53e2\u96c6",level:2},{value:"Kubernetes \u53e2\u96c6\u6574\u5408 Vault \u670d\u52d9",id:"kubernetes-\u53e2\u96c6\u6574\u5408-vault-\u670d\u52d9",level:2},{value:"Vault \u8207 Secrets Store CSI Driver \u6574\u5408",id:"vault-\u8207-secrets-store-csi-driver-\u6574\u5408",level:2},{value:"\u4f7f\u7528 ENV \u65b9\u5f0f\u5ba3\u544a",id:"\u4f7f\u7528-env-\u65b9\u5f0f\u5ba3\u544a",level:3},{value:"\u4f7f\u7528 FILE \u65b9\u5f0f\u5ba3\u544a",id:"\u4f7f\u7528-file-\u65b9\u5f0f\u5ba3\u544a",level:3},{value:"\u7e3d\u7d50",id:"\u7e3d\u7d50",level:2},{value:"\u53c3\u8003\u8cc7\u6599",id:"\u53c3\u8003\u8cc7\u6599",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"quarkus-\u6574\u5408-vault-\u8207-secrets-store-csi-driver",children:"Quarkus \u6574\u5408 Vault \u8207 Secrets Store CSI Driver"}),"\n",(0,r.jsx)(n.p,{children:"Vault \u662f\u4e00\u500b\u53ef\u5c07\u6a5f\u5bc6\u8cc7\u8a0a\u96c6\u4e2d\u5316\u7ba1\u7406\u7684\u4e00\u500b\u5e73\u53f0\uff0c\u4e0d\u8ad6\u662f\u6191\u8b49\u3001\u5bc6\u78bc\u7b49\u3002\u518d\u8005\u8981\u5b58\u53d6\u9019\u4e9b\u8cc7\u8a0a\u90fd\u8981\u7d93\u904e\u4e00\u5c64\u8eab\u4efd\u9a57\u8b49\u624d\u80fd\u7372\u53d6\u5132\u5b58\u5728 Vault \u670d\u52d9\u4e0a\u7684\u6a5f\u5bc6\u8cc7\u8a0a\u3002\u5c08\u6848\u6574\u5408 Vault \u670d\u52d9\u80fd\u5920\u964d\u4f4e\u654f\u611f\u6578\u64da\u66b4\u9732\u98a8\u96aa\u3001\u96c6\u4e2d\u7ba1\u7406\u63d0\u9ad8\u751f\u7522\u6548\u7387\u7b49\u3002\u672c\u6587\u7ae0\u6703\u900f\u904e\u7b2c\u4e09\u65b9\u5de5\u5177\u6574\u5408 Vault \u5be6\u73fe\u7121\u5165\u4fb5\u7a0b\u5f0f\u78bc\uff0c\u5176\u512a\u52e2\u53ef\u4ee5\u5c07\u4e0d\u719f\u6089\u7684\u5c08\u6848\u9032\u884c\u6574\u5408\u3002"}),"\n",(0,r.jsx)(n.p,{children:"\u6b64\u6587\u7ae0\u6703\u5b78\u7fd2\u5230"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Vault \u670d\u52d9\u6574\u5408\u5916\u90e8 Kubernetes"}),"\n",(0,r.jsx)(n.li,{children:"Secrets Store CSI Driver \u6574\u5408 Vault"}),"\n",(0,r.jsx)(n.li,{children:"\u4f7f\u7528 Secrets Store CSI Driver CRDs \u5ba3\u544a\u8cc7\u6e90"}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u5be6\u9a57\u74b0\u5883"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"OS: Windows 11 WSL"}),"\n",(0,r.jsx)(n.li,{children:"Docker Engine: 23.0.5"}),"\n",(0,r.jsx)(n.li,{children:"k3d version: v5.6.0"}),"\n",(0,r.jsx)(n.li,{children:"kubectl version: v1.27.1"}),"\n",(0,r.jsx)(n.li,{children:"Helm version: v3.11.3"}),"\n",(0,r.jsx)(n.li,{children:"Vault chart version: 0.26.1"}),"\n",(0,r.jsx)(n.li,{children:"Secrets Store CSI chart version: 1.4.0"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u672c\u5be6\u9a57\u74b0\u5883\u7684\u5efa\u7f6e\u53ef\u61c9\u7528\u65bc\u6a19\u6e96 Kubernetes \u53e2\u96c6\u3002\u672c\u5be6\u9a57\u6240\u4f7f\u7528\u7684\u5c08\u6848",(0,r.jsx)(n.a,{href:"https://github.com/CCH0124/vault-with-quarkus/tree/d939a7b057bf7688b9ee6162fe2cf4fa0365db9d/secret-csi-vault",children:"\u9023\u7d50"}),"\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"\u5efa\u7acb\u74b0\u5883",children:"\u5efa\u7acb\u74b0\u5883"}),"\n",(0,r.jsx)(n.h3,{id:"vault-\u670d\u52d9",children:"Vault \u670d\u52d9"}),"\n",(0,r.jsxs)(n.p,{children:["\u5ba3\u544a K3d \u8a2d\u5b9a\uff0c\u8a2d\u5b9a\u5c0d\u61c9\u672c\u5be6\u9a57",(0,r.jsx)(n.a,{href:"https://raw.githubusercontent.com/CCH0124/vault-with-quarkus/main/infra/k3d/config.yaml",children:"\u5c08\u6848"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# config.yaml\napiVersion: k3d.io/v1alpha4 \nkind: Simple \nmetadata:\n  name: vault-cluster \nservers: 1 \nagents: 2  \nkubeAPI: \n  host: "vault.cch.com" \n  hostIP: "127.0.0.1" \n  hostPort: "6450"\nimage: rancher/k3s:v1.27.7-k3s1\nnetwork: vault-net\nports:\n  - port: 8050:80\n    nodeFilters:\n      - loadbalancer\n  - port: 8453:443\n    nodeFilters:\n      - loadbalancer\noptions:\n  k3s:\n    extraArgs:\n      - arg: --disable=traefik\n        nodeFilters:\n          - server:*\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u4f7f\u7528\u4e0a\u8ff0\u8a2d\u5b9a\u6a94\u5efa\u7acb\u6a21\u64ec Kubernetes \u74b0\u5883"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"k3d cluster create --servers-memory 3G  --agents-memory 3G -c config.yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5b89\u88dd Nginx Ingress \u670d\u52d9"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ helm repo add ingress-nginx  https://kubernetes.github.io/ingress-nginx\n$ helm search repo ingress-nginx\n$ helm install ingress-nginx ingress-nginx/ingress-nginx --version 4.8.3 --namespace ingress-nginx --create-namespace\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5b89\u88dd Vault \u670d\u52d9"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ helm repo add hashicorp https://helm.releases.hashicorp.com\n$ helm search repo hashicorp/vault\n$ helm install vault hashicorp/vault --version 0.26.1 --namespace vault --create-namespace -f values.yaml\nNAME: vault\nLAST DEPLOYED: Thu Nov 30 20:51:14 2023\nNAMESPACE: vault\nSTATUS: deployed\nREVISION: 1\nNOTES:\nThank you for installing HashiCorp Vault!\n\nNow that you have deployed Vault, you should look over the docs on using\nVault with Kubernetes available here:\n\nhttps://developer.hashicorp.com/vault/docs\n\n\nYour release is named vault. To learn more about the release, try:\n\n  $ helm status vault\n  $ helm get manifest vault\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5b89\u88dd\u5b8c\u4e4b\u5f8c\u9700\u8981\u89e3\u5c01\uff0c\u624d\u80fd\u5b58\u53d6 Vault \u4e2d\u7684\u8cc7\u6e90\uff0c\u9019\u662f\u4e00\u500b Vault \u52a0\u5bc6\u6a5f\u5236\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ kubectl --namespace vault exec -it vault-0 -- vault operator init\nUnseal Key 1: SOb6GoV2ScLTwDNzSy4igMSLjlMsW3DnpXc47/bm4Yxx\nUnseal Key 2: TuI2LjfKBxPgrmMWOvTYmjFcfgjFKrbnmloWWMPXYnov\nUnseal Key 3: JMY26yi9G1h14s7vvHB4aryF16Di3SnPj/W6kdseis6d\nUnseal Key 4: QKQdXjp2sqPOqluU/DFn3ogvOUD2MwtH4+NwTlL5ufRh\nUnseal Key 5: JBfWTtw/JSw+3iHbgNP1SXVQN94YztbXARZL682KCQMp\n\nInitial Root Token: hvs.QyjNEBlD8y5BH4KsYycz5k5K\n\nVault initialized with 5 key shares and a key threshold of 3. Please securely\ndistribute the key shares printed above. When the Vault is re-sealed,\nrestarted, or stopped, you must supply at least 3 of these keys to unseal it\nbefore it can start servicing requests.\n\nVault does not store the generated root key. Without at least 3 keys to\nreconstruct the root key, Vault will remain permanently sealed!\n\nIt is possible to generate new unseal keys, provided you have a quorum of\nexisting unseal keys shares. See "vault operator rekey" for more information.\n'})}),"\n",(0,r.jsx)(n.h2,{id:"\u5efa\u7f6e-quarkus-kubernetes-\u53e2\u96c6",children:"\u5efa\u7f6e Quarkus Kubernetes \u53e2\u96c6"}),"\n",(0,r.jsxs)(n.p,{children:["\u8a2d\u5b9a Quarkus Kubernetes \u53e2\u96c6\uff0c\u5c0d\u61c9\u672c\u5be6\u9a57",(0,r.jsx)(n.a,{href:"https://raw.githubusercontent.com/CCH0124/vault-with-quarkus/main/secret-csi-vault/k3d/config.yaml",children:"\u5c08\u6848"}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: k3d.io/v1alpha4\nkind: Simple\nmetadata:\n  name: quarkus-cluster\nservers: 1\nagents: 1\nkubeAPI: \n  host: "app.cch.com" \n  hostIP: "127.0.0.1"\n  hostPort: "6451"\nimage: rancher/k3s:v1.27.7-k3s1\nnetwork: vault-net\nports:\n  - port: 8051:80\n    nodeFilters:\n      - loadbalancer\n  - port: 8451:443\n    nodeFilters:\n      - loadbalancer\noptions:\n  k3s:\n    extraArgs:\n      - arg: --disable=traefik\n        nodeFilters:\n          - server:*\n'})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ k3d cluster create -c config.yaml --servers-memory 2GB --agents-memory 2GB\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u5be6\u9a57\u5c08\u6848\u662f\u900f\u904e Quarkus \u6846\u67b6\u4f86\u6574\u5408 Vault\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"kubernetes-\u53e2\u96c6\u6574\u5408-vault-\u670d\u52d9",children:"Kubernetes \u53e2\u96c6\u6574\u5408 Vault \u670d\u52d9"}),"\n",(0,r.jsx)(n.p,{children:"Quarkus \u5c08\u6848\u6703\u90e8\u7f72\u81f3 Quarkus Kubernetes \u53e2\u96c6\uff0c\u4f46 Vault \u670d\u52d9\u70ba\u53e6\u4e00\u500b\u53eb vault-cluster \u7684\u74b0\u5883\u3002\u4e0b\u9762\u5c07\u6703\u793a\u7bc4\u5982\u4f55\u5f9e Vault \u8a2d\u5b9a\u57fa\u65bc Kubernetes \u7684\u8a8d\u8b49\uff0c\u4ee5\u8b93 quarkus-cluster \u4e2d quarkus \u61c9\u7528\u7a0b\u5f0f\u5b58\u53d6\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728 quarkus-cluster \u53e2\u96c6\u4e2d\u624b\u52d5\u5efa\u7f6e\u4e00\u500b\u7d66 ",(0,r.jsx)(n.code,{children:"ServiceAccount"})," \u7684\u9577\u671f API \u4ee4\u724c\uff0c\u4e26\u900f\u904e ",(0,r.jsx)(n.code,{children:"kubernetes.io/service-account.name"})," \u5efa\u7acb\u4e00\u500b\u65b0 ",(0,r.jsx)(n.code,{children:"Secret"})," \u7269\u4ef6\uff0c\u5167\u5bb9\u5305\u542b ",(0,r.jsx)(n.code,{children:"ca.crt"}),"\u3001",(0,r.jsx)(n.code,{children:"token"})," \u7b49\u6b04\u4f4d\u3002\u6709\u95dc\u624b\u52d5\u5efa\u7acb\u9577\u671f\u4ee4\u724c\u53ef\u53c3\u95b1",(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/#manually-create-a-long-lived-api-token-for-a-serviceaccount",children:"\u5b98\u65b9\u6587\u4ef6"}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: vault-auth\n  labels:\n    app.kubernetes.io/managed-by: vault\n---\napiVersion: v1\nkind: Secret\nmetadata:\n  name: vault-auth\n  annotations:\n    kubernetes.io/service-account.name: vault-auth\ntype: kubernetes.io/service-account-token\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n   name: role-tokenreview-binding\nroleRef:\n   apiGroup: rbac.authorization.k8s.io\n   kind: ClusterRole\n   name: system:auth-delegator\nsubjects:\n- kind: ServiceAccount\n  name: vault-auth\n  namespace: default\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u900f\u904e ",(0,r.jsx)(n.code,{children:"kubernetes.io/service-account-token"})," \u5efa\u7acb\u7684\u9577\u671f\u4ee4\u724c\u5c07\u8ce6\u4e88\u7d66 Vault \u670d\u52d9\u4e26\u8207 quarkus-cluster \u4e92\u52d5\u3002\u5982\u679c\u4f7f\u7528\u77ed\u671f\u4ee4\u724c\uff0c\u4e00\u65e6 Pod \u6216 ",(0,r.jsx)(n.code,{children:"ServiceAccount"})," \u88ab\u522a\u9664 Kubernetes \u5c31\u6703\u64a4\u92b7\u5b83\uff0c\u6216\u8005\u5982\u679c\u4ee4\u724c\u904e\u671f\u5f8c\uff0cVault \u5c07\u7121\u6cd5\u518d\u4f7f\u7528\u8a72\u4ee4\u724c\u8207 Kubernetes API\u3002\u4f46\uff0c\u9577\u671f\u4ee4\u724c\u6c92\u6709\u77ed\u671f\u4ee4\u724c\u7684\u5b89\u5168\u6027\uff0c\u4f46\u5169\u65b9\u5f0f\u90fd\u80fd\u6574\u5408\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u8a2d\u5b9a\u7d66 Vault \u9a57\u8b49 quarkus-cluster \u8cc7\u8a0a\u3002",(0,r.jsx)(n.code,{children:"K8S_HOST"})," \u5c0d\u65bc\u672c\u7bc4\u4f8b\u4f86\u8aaa\u6703\u6709\u74b0\u5883\u4e0a\u7db2\u8def\u8def\u7531\u554f\u984c\uff0c\u56e0\u6b64\u6703\u4f7f\u7528 k3d \u5efa\u7f6e\u51fa\u4f86\u7684 ",(0,r.jsx)(n.code,{children:"serverlb"})," \u5bb9\u5668 IP \u4f4d\u7f6e\u3002\u81f3\u65bc\u80fd\u5920\u901a\u8a0a\u662f\u900f\u904e ",(0,r.jsx)(n.code,{children:"network: vault-net"})," \u8a2d\u5b9a\u3002\u4e0b\u9762\u70ba\u5be6\u9a57\u6b65\u9a5f\uff1a"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u767b\u5165 Vault"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export VAULT_ADDR=https://vault-demo.cch.com:8453\nexport VAULT_SKIP_VERIFY=true\nvault login -tls-skip-verify hvs.2fVKDYNbdS1kxa186pWZuDWn\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsx)(n.li,{children:"\u5efa\u7f6e\u8a2d\u5b9a\u7d66 Vault \u9a57\u8b49\u7684\u8cc7\u8a0a"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"export SA_JWT_TOKEN=$(kubectl get secret  vault-auth -o jsonpath=\"{ .data.token }\" | base64 --decode; echo)\nkubectl -n default get secret  vault-auth -o jsonpath=\"{.data['ca\\.crt']}\" | base64 --decode | tee -a ca.crt\nexport K8S_HOST=$(kubectl config view --raw --minify --flatten -o jsonpath='{.clusters[].cluster.server}')\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsx)(n.li,{children:"Vault \u670d\u52d9\u555f\u7528 Kubernetes \u8a8d\u8b49"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ vault auth enable --path=quarkus-cluster kubernetes\nSuccess! Enabled kubernetes auth method at: quarkus-cluster\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"4",children:["\n",(0,r.jsx)(n.li,{children:"\u8a2d\u5b9a quarkus-cluster \u8a8d\u8b49"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ vault write auth/quarkus-cluster/config token_reviewer_jwt=$SA_JWT_TOKEN kubernetes_host=https://172.20.0.6:6443 kubernetes_ca_cert="$(cat ca.crt)"\n$ vault read  auth/quarkus-cluster/config\nKey                       Value\n---                       -----\ndisable_iss_validation    true\ndisable_local_ca_jwt      false\nissuer                    n/a\nkubernetes_ca_cert        -----BEGIN CERTIFICATE-----\nMIIBdzCCAR2gAwIBAgIBADAKBggqhkjOPQQDAjAjMSEwHwYDVQQDDBhrM3Mtc2Vy\ndmVyLWNhQDE3MDE1OTUyNTQwHhcNMjMxMjAzMDkyMDU0WhcNMzMxMTMwMDkyMDU0\nWjAjMSEwHwYDVQQDDBhrM3Mtc2VydmVyLWNhQDE3MDE1OTUyNTQwWTATBgcqhkjO\nPQIBBggqhkjOPQMBBwNCAAROecAvJxanXKn5xhGgPAIr4vCSkUON/gTK804MxLAw\nAaYiNJIHZcBCsF2HrLjno9Z5WXgMr4auihygOCH+duMEo0IwQDAOBgNVHQ8BAf8E\nBAMCAqQwDwYDVR0TAQH/BAUwAwEB/zAdBgNVHQ4EFgQUIZoFjtr+3eM5JOD6Bj7r\nCtjOPjUwCgYIKoZIzj0EAwIDSAAwRQIgPASRbtat2BdrxFfhN2vE4mJqt+G4Q3c6\nWPp0RVUPPYACIQDBNsAVzwTTCBYTd49DrVd3KyA6q19nY21bxMtVMHjxtw==\n-----END CERTIFICATE-----\nkubernetes_host           https://172.20.0.6:6443\npem_keys                  []\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"5",children:["\n",(0,r.jsx)(n.li,{children:"\u5efa\u7f6e quarkus-cluster \u8a8d\u8b49\u7684\u89d2\u8272"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"vault write auth/quarkus-cluster/role/quarkus-vault \\\n    bound_service_account_names=* \\\n    bound_service_account_namespaces=* \\\n    policies=quarkus \\\n    ttl=24h\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u9019\u908a ",(0,r.jsx)(n.code,{children:"*"})," \u8868\u793a\u6240\u6709\u7684\u610f\u601d\uff0c\u4f46\u5efa\u8b70\u6703\u662f\u660e\u78ba\u7684\u5b9a\u7fa9\u3002",(0,r.jsx)(n.code,{children:"policies"})," \u5247\u70ba\u5b58\u53d6\u8cc7\u6e90\u50cf\u662f KV \u5f15\u64ce\u3001KPI \u7684\u6b0a\u9650\u63a7\u7ba1\u3002"]}),"\n",(0,r.jsxs)(n.ol,{start:"6",children:["\n",(0,r.jsx)(n.li,{children:"\u9a57\u8b49"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u672c\u5be6\u9a57\u7684 Quarkus \u5c08\u6848\u5b9a\u7fa9\u4e86\u4e00\u500b ",(0,r.jsx)(n.code,{children:"greeting.message"})," \u74b0\u5883\u8b8a\u6578\uff0c\u56e0\u6b64\u4e0b\u9762\u6703\u5b9a\u7fa9 KV \u5f15\u64ce\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u555f\u7528 secrets \u5f15\u64ce\uff0c\u5b9a\u7fa9\u7248\u672c 2\uff0c\u4e14\u8def\u5f91 kv\n$ vault secrets enable -version=2 kv\nSuccess! Enabled the kv secrets engine at: kv/\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u63a8\u9001 ",(0,r.jsx)(n.code,{children:"greeting.message"})," \u7684 KV \u503c\u81f3 Vault\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ vault kv put kv/quarkus/vault-demo greeting.message="vault hello!"\n======= Secret Path =======\nkv/data/quarkus/vault-demo\n\n======= Metadata =======\nKey                Value\n---                -----\ncreated_time       2023-12-03T04:48:18.833082542Z\ncustom_metadata    <nil>\ndeletion_time      n/a\ndestroyed          false\nversion            1\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u5b9a\u7fa9 ",(0,r.jsx)(n.code,{children:"policy"}),"\uff0c\u6703\u5c0d\u61c9\u5230\u7b2c 5 \u6b65\u9a5f ",(0,r.jsx)(n.code,{children:"policies"})," \u7684\u503c\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# policy.hcl\npath "kv/data/quarkus/vault-demo" {\n    capabilities = ["read"]\n}\n# \u5b9a\u7fa9\u500b\u540d\u7a31\u70ba quarkus \u7684 policy \u89d2\u8272\nvault policy write quarkus policy.hcl\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u6700\u5f8c\u900f\u904e\u90e8\u7f72 Quarkus \u8cc7\u6e90\u9a57\u8b49\uff0c\u90e8\u7f72\u6a94\u6848\u900f\u904e\u6b64",(0,r.jsx)(n.a,{href:"https://github.com/CCH0124/vault-with-quarkus/blob/main/secret-csi-vault/k8s/deployment.yaml",children:"\u9023\u7d50"}),"\u53d6\u5f97\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# \u5728 quarkus-cluster \u90e8\u7f72\nkubectl apply -f k8s/deployment.yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6210\u529f\u7372\u53d6 Vault \u4e0a\u5b9a\u7fa9\u7684\u503c\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ curl -k https://app.cch.com:8451/info\n{"message":"vault hello!"}\n'})}),"\n",(0,r.jsx)(n.p,{children:"\u5230\u9019\u908a\u53ef\u4ee5\u77e5\u9053\u5982\u4f55\u900f\u904e\u4e00\u500b Vault \u670d\u52d9\u6574\u5408\u5916\u90e8\u7684 Kubernetes\u3002\u4e26\u900f\u904e Quarkus \u6846\u67b6\u6240\u63d0\u4f9b\u7684 Vault API \u9032\u884c\u4e92\u52d5\uff0c\u8a2d\u5b9a\u5982\u4e0b\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"quarkus.tls.trust-all=true\nquarkus.vault.url=https://vault-demo.cch.com:8453 # \u5b9a\u7fa9\u9023\u7dda Vault API \u4f4d\u7f6e\nquarkus.vault.kv-secret-engine-mount-path=kv\nquarkus.vault.secret-config-kv-path=quarkus/vault-demo\nquarkus.vault.kv-secret-engine-version=2\nquarkus.vault.authentication.kubernetes.auth-mount-path=auth/quarkus-cluster\nquarkus.vault.authentication.kubernetes.role=quarkus-vault\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u672c\u7bc4\u4f8b\u7684 Quarkus \u61c9\u7528\u7a0b\u5f0f\u6210\u529f\u9023\u7dda\u5f8c\uff0c\u5728 Vault \u670d\u52d9\u53ef\u4ee5\u770b\u5230\u5176\u65e5\u8a8c\u3002Pod \u4e2d\u5bb9\u5668\u61c9\u7528\u7a0b\u5f0f\u5c07\u900f\u904e Vault API ",(0,r.jsx)(n.code,{children:"/v1/auth/quarkus-cluster/login"})," \u9032\u884c\u767b\u5165\uff0c\u4e26\u9a57\u8b49\u4f86\u81ea ",(0,r.jsx)(n.code,{children:"serviceAccount"})," \u4ee4\u724c\uff0c\u6210\u529f\u5f8c\u518d\u900f\u904e Vault API ",(0,r.jsx)(n.code,{children:"/v1/kv/data/quarkus/vault-demo"})," \u7372\u53d6 ",(0,r.jsx)(n.code,{children:"secrets"})," \u8cc7\u6e90\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'{"@level":"debug","@message":"completed_request","@module":"core","@timestamp":"2023-12-06T11:33:22.628656Z","client_address":"10.42.2.1","client_id":"","duration":"2ms","request_method":"POST","request_path":"/v1/auth/quarkus-cluster/login","start_time":"2023-12-06T11:33:22Z","status_code":200}\n{"@level":"debug","@message":"completed_request","@module":"core","@timestamp":"2023-12-06T11:33:22.660627Z","client_address":"10.42.2.1","client_id":"faf515ee-37d8-f117-1afe-d9d4879850ed","duration":"0ms","request_method":"GET","request_path":"/v1/kv/data/quarkus/vault-demo","start_time":"2023-12-06T11:33:22Z","status_code":200}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"vault-\u8207-secrets-store-csi-driver-\u6574\u5408",children:"Vault \u8207 Secrets Store CSI Driver \u6574\u5408"}),"\n",(0,r.jsxs)(n.p,{children:["\u5b89\u88dd ",(0,r.jsx)(n.code,{children:"Secrets Store CSI Driver"})," \u6642 K3d \u7248\u672c\u8981 v5.6.0\uff0c\u5426\u5247\u6703\u6709 ",(0,r.jsx)(n.a,{href:"https://github.com/kubernetes-sigs/secrets-store-csi-driver/issues/1017",children:"CreateContainerError"})," \u932f\u8aa4\u8a0a\u606f\uff0c\u904b\u884c K3d \u9700\u591a\u505a\u9019\u4e00\u6b65 ",(0,r.jsx)(n.a,{href:"https://github.com/k3d-io/k3d/pull/1268",children:"K3D_FIX_MOUNTS"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u4f7f\u7528 Helm \u5b89\u88dd\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts\nhelm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver --version 1.4.0 --namespace kube-system --set syncSecret.enabled=true\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5b89\u88dd\u5b8c\u5f8c\u6bcf\u500b\u7bc0\u9ede\u90fd\u6703\u6709\u4e00\u500b Pod\uff0c\u8a72 Pod \u662f\u7531 ",(0,r.jsx)(n.code,{children:"DaemonSet"})," \u6240\u7522\u751f\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ kubectl get pods -A -l app.kubernetes.io/instance=csi-secrets-store -o wide\nNAMESPACE     NAME                                               READY   STATUS    RESTARTS   AGE     IP          NODE                           NOMINATED NODE   READINESS GATES\nkube-system   csi-secrets-store-secrets-store-csi-driver-ss22c   3/3     Running   0          3h38m   10.42.1.4   k3d-quarkus-cluster-server-0   <none>           <none>\nkube-system   csi-secrets-store-secrets-store-csi-driver-vg547   3/3     Running   0          3h38m   10.42.0.4   k3d-quarkus-cluster-agent-0    <none>           <none>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5b89\u88dd ",(0,r.jsx)(n.a,{href:"https://github.com/hashicorp/vault-csi-provider",children:"vault-csi-provider"}),"\uff0c\u4ee5\u8b93 Secrets Store CSI \u53d6\u5f97\u5132\u5b58\u5728 Vault \u4e2d\u7684\u8cc7\u8a0a\uff0c\u4e26\u4f7f\u7528 Secrets Store CSI \u4ecb\u9762\u5c07\u5b83\u5011\u639b\u8f09\u5230 Kubernetes Pod \u4e2d\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u4f7f\u7528 Helm \u5b89\u88dd Vault \u7684 CSI \u4ecb\u9762\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'helm install vault hashicorp/vault --version 0.26.1 --namespace vault --create-namespace  --set "server.enabled=false" --set "injector.enabled=false" --set "csi.enabled=true"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u5982\u679c\u4e0d\u5b89\u88dd vault-csi-provider\uff0c\u5247\u6703\u5c0e\u81f4 Secrets Store CSI \u4ecb\u9762\u4e0d\u77e5\u9053\u5982\u4f55\u6574\u5408 Vault\uff0c\u5728\u555f\u52d5 Pod \u6642\u6703\u51fa\u73fe\u4ee5\u4e0b\u8a0a\u606f ",(0,r.jsx)(n.code,{children:'provider not found: provider "vault"'}),"\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'  Warning  FailedMount  22m (x13 over 32m)    kubelet            MountVolume.SetUp failed for volume "vault-secret-env" : rpc error: code = Unknown desc = failed to mount secrets store objects for pod default/secret-csi-vault-7b98fd57d5-5kxfw, err: error connecting to provider "vault": provider not found: provider "vault"\n  Warning  FailedMount  12m (x8 over 30m)     kubelet            Unable to attach or mount volumes: unmounted volumes=[vault-secret-env vault-secret-file], unattached volumes=[], failed to process volumes=[]: timed out waiting for the condition\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u8a72 Secrets store CSI \u9084\u80fd\u5920\u6574\u5408\u5176\u5b83\u7b2c\u4e09\u65b9\u670d\u52d9\u53ef\u53c3\u8003",(0,r.jsx)(n.a,{href:"https://secrets-store-csi-driver.sigs.k8s.io/providers",children:"\u5b98\u65b9\u8cc7\u8a0a"}),"\u3002\u672c\u5be6\u9a57\u6703\u6574\u5408 Vault\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u9996\u5148\u7919\u65bc K3d \u5efa\u7acb\u74b0\u5883\uff0c\u9019\u908a Vault \u4f7f\u7528 NodePort \u65b9\u5f0f\u5c07 Vault \u670d\u52d9\u7d66\u5c0e\u51fa\u3002\u8b80\u8005\u5982\u6709\u4e0d\u7528 NodePort \u65b9\u5f0f\uff0c\u5728\u4e0d\u541d\u55c7\u5206\u4eab\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ kubectl get svc -n vault\nNAME                       TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE\n...\nvault                      NodePort    10.43.27.225    <none>        8200:30820/TCP,8201:31082/TCP   18h\n# \u627e\u51fa vault \u6240\u5c6c\u7684\u7bc0\u9ede\n$ kubectl get pods -o wide -n vault\nNAME                                  READY   STATUS    RESTARTS   AGE   IP          NODE                         NOMINATED NODE   READINESS GATES\nvault-agent-injector-7fc4b89f-8hjk9   1/1     Running   0          18h   10.42.1.5   k3d-vault-cluster-agent-1    <none>           <none>\nvault-0                               1/1     Running   0          18h   10.42.2.8   k3d-vault-cluster-server-0   <none>           <none>\n# \u7372\u53d6 Vault \u6240\u5c6c\u7bc0\u9ede\u7684 IP \n$ kubectl get node -o wide\nNAME                         STATUS   ROLES                  AGE   VERSION        INTERNAL-IP   EXTERNAL-IP   OS-IMAGE   KERNEL-VERSION                       CONTAINER-RUNTIME\nk3d-vault-cluster-server-0   Ready    control-plane,master   18h   v1.27.7+k3s1   172.20.0.5    <none>        K3s dev    5.15.133.1-microsoft-standard-WSL2   containerd://1.7.7-k3s1.27\nk3d-vault-cluster-agent-1    Ready    <none>                 18h   v1.27.7+k3s1   172.20.0.7    <none>        K3s dev    5.15.133.1-microsoft-standard-WSL2   containerd://1.7.7-k3s1.27\nk3d-vault-cluster-agent-0    Ready    <none>                 18h   v1.27.7+k3s1   172.20.0.6    <none>        K3s dev    5.15.133.1-microsoft-standard-WSL2   containerd://1.7.7-k3s1.27\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6574\u7406\u7e3d\u9ad4\u7684\u6d41\u7a0b\uff0c\u5176\u67b6\u69cb\u5716\u6703\u5982\u4e0b\u3002"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(932).Z+"",width:"1441",height:"540"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"\u5728 Vault \u8a2d\u7f6e\u5f9e vault-auth \u4f86\u7684\u4ee4\u724c\u3001Kubernetes API \u4f4d\u7f6e"}),"\n",(0,r.jsx)(n.li,{children:"\u5c07 Pod \u5efa\u7acb\u7684 ServiceAccount \u4ee4\u724c\u639b\u8f09\u81f3\u5bb9\u5668\u4e2d"}),"\n",(0,r.jsxs)(n.li,{children:["Quarkus \u900f\u904e ServiceAccount \u4ee4\u724c\u547c\u53eb ",(0,r.jsx)(n.code,{children:"/v1/auth/quarkus-cluster/login"})," \u9032\u884c\u9a57\u8b49"]}),"\n",(0,r.jsxs)(n.li,{children:["Vault \u547c\u53eb ",(0,r.jsx)(n.code,{children:"quarkus-cluster"})," \u6240\u8a2d\u5b9a\u7684 Kubernetes API \u4f4d\u7f6e\u547c\u53eb tokenReview API \u9a57\u8b49\u4ee4\u724c\u5408\u6cd5\u6027"]}),"\n",(0,r.jsx)(n.li,{children:"Vault \u56de\u50b3\u4ee4\u724c"}),"\n",(0,r.jsxs)(n.li,{children:["\u900f\u904e\u7b2c 5 \u6b65\u4ee4\u724c\u7372\u53d6 ",(0,r.jsx)(n.code,{children:"/v1/kv/data/quarkus/vault-demo"})," \u7684 KV \u503c"]}),"\n",(0,r.jsx)(n.li,{children:"\u56de\u50b3 KV \u503c"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["\u6e96\u5099\u597d\u4e0a\u9762\u7684\u9375\u503c\u5c0d\u5f8c\uff0c\u5c07\u900f\u904e Secrets Store CSI \u63d0\u4f9b\u7684 CRD \u9032\u884c Vault \u5b58\u53d6\u5ba3\u544a\uff0c\u9019\u908a\u6703\u5206\u6210\u57fa\u65bc ENV \u548c FILE \u4f86\u505a\u5206\u4eab\uff0c\u90e8\u7f72\u7bc4\u4f8b\u5c0d\u61c9\u672c\u5c08\u6848",(0,r.jsx)(n.a,{href:"https://raw.githubusercontent.com/CCH0124/vault-with-quarkus/main/secret-csi-vault/k8s/deployment-secret-csi.yaml",children:"\u8a2d\u5b9a"}),"\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u4f7f\u7528-env-\u65b9\u5f0f\u5ba3\u544a",children:"\u4f7f\u7528 ENV \u65b9\u5f0f\u5ba3\u544a"}),"\n",(0,r.jsx)(n.p,{children:"\u5efa\u7acb\u4e00\u500b\u53ef\u900f\u904e Secrets Store CSI \u63d0\u4f9b\u7684 CRD \u4f86\u5b58\u53d6 Vault \u4e2d KV \u8cc7\u6e90\u3002\u9810\u8a2d\u4e0a\uff0cKV \u8cc7\u6e90\u4e1f\u4ec0\u9ebc\u503c\u5c31\u53d6\u4ec0\u9ebc\u503c\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# ENV base\napiVersion: secrets-store.csi.x-k8s.io/v1\nkind: SecretProviderClass\nmetadata:\n  name: quarkus-demo-env\n  labels:\n    app.kubernetes.io/managed-by: "vault"\nspec:\n  provider: vault\n  parameters:\n    roleName: \'quarkus-vault\'\n    vaultAddress: \'http://172.20.0.5:30820\'\n    vaultAuthMountPath: \'quarkus-cluster\'\n    objects: |\n      - objectName: "greeting.message"\n        secretPath: "kv/data/quarkus/vault-demo?version=1"\n        secretKey: "greeting.message"\n  secretObjects:\n    - data:\n      - key: greeting.message\n        objectName: greeting.message\n      secretName: quarkus\n      type: Opaque\n      labels:\n        app.kubernetes.io/managed-by: "quarkus"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u7576\u90e8\u7f72 ",(0,r.jsx)(n.code,{children:"kubectl apply -f k8s/deployment-secret-csi.yaml"})," \u5f8c\u53ef\u4ee5\u767c\u73fe\uff0c\u5728\u4e0a\u8ff0\u4f7f\u7528 ENV \u65b9\u5f0f\u5efa\u7acb\u7684 ",(0,r.jsx)(n.code,{children:"SecretProviderClass"})," \u7269\u4ef6\uff0c\u900f\u904e ",(0,r.jsx)(n.code,{children:"secretObjects"})," \u6b04\u4f4d\u5efa\u7acb\u4e00\u500b ",(0,r.jsx)(n.code,{children:"secret"})," \u7269\u4ef6\u5982\u4e0b\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ kubectl get secret\nNAME         TYPE                                  DATA   AGE\n...\nquarkus      Opaque                                1      51m\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5176 ",(0,r.jsx)(n.code,{children:"Secret"})," \u8cc7\u6e90\u53ef\u4ee5\u88ab\u5f15\u7528\uff0c\u5728 ",(0,r.jsx)(n.code,{children:"deployment"})," \u7269\u4ef6\u4e2d\u53ef\u5ba3\u544a\u5982\u4e0b\u5f15\u7528\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"...\n      containers:\n        - env:\n            - name: KUBERNETES_NAMESPACE\n              valueFrom:\n                fieldRef:\n                  fieldPath: metadata.namespace\n            - name: GREETING_MESSAGE # \u5f15\u7528\u540d\u7a31\u70ba quarkus-demo-env \u7684 SecretProviderClass CRD \u6240\u5efa\u7acb\u7684 Secret \u8cc7\u6e90\n              valueFrom:\n                secretKeyRef:\n                  name: quarkus\n                  key: greeting.message\n...\n          volumeMounts:\n...\n          - name: vault-secret-env\n            mountPath: \"/mnt/secrets-store\"\n            readOnly: true\n...\n      volumes: # \u5728 volumes \u6b04\u4f4d\u5ba3\u544a\u5f15\u7528 CSI \u4ecb\u9762\u8a2d\u5b9a\n...\n      - name: vault-secret-env\n        csi:\n          driver: 'secrets-store.csi.k8s.io'\n          readOnly: true\n          volumeAttributes:\n            secretProviderClass: 'quarkus-demo-env'\n...\n"})}),"\n",(0,r.jsx)(n.p,{children:"API \u9a57\u8b49"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ curl -k https://app.cch.com:8451/info\n{"message":"vault hello!"}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u9019\u908a\u8981\u6ce8\u610f\u7684\u662f\u5982\u679c\u8981\u555f\u7528 ",(0,r.jsx)(n.code,{children:"secretObjects"})," \u529f\u80fd\uff0c\u5373\u8b93 CSI \u4ecb\u9762\u5e6b\u4f60\u5efa\u7acb\u4e00\u500b ",(0,r.jsx)(n.code,{children:"secret"})," \u7269\u4ef6\uff0c\u8981\u5728\u5b89\u88dd CSI \u6642\u555f\u7528\u8a72\u529f\u80fd ",(0,r.jsx)(n.code,{children:"--set syncSecret.enabled=true"}),"\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"\u4f7f\u7528-file-\u65b9\u5f0f\u5ba3\u544a",children:"\u4f7f\u7528 FILE \u65b9\u5f0f\u5ba3\u544a"}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u4e0a\u9762\u6b65\u9a5f\u5efa\u7acb\u7684 quarkus/vault-demo \u8def\u5f91\u4e0b\u65b0\u589e\u4e00\u500b ",(0,r.jsx)(n.code,{children:"fullchain.crt"})," \u7684\u9375\u503c\u5c0d\uff0c\u672c\u7bc4\u4f8b\u9700\u8981\u4e00\u500b\u6191\u8b49\u639b\u8f09\u81f3\u670d\u52d9\u4e2d\u624d\u80fd\u57f7\u884c\u9a57\u8b49\u7d42\u7aef\u6191\u8b49\u7684 API\u3002\u9019\u908a\u6703\u5c07 pki \u76ee\u9304\u4e0b\u7684\u6a94\u6848\u9032\u884c base64 \u7de8\u78bc\u5728\u5beb\u5165 Vault \u4e2d KV \u8cc7\u6e90\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ secret-csi-vault/pki$ export FULL_CHAIN=$(cat ca-bundle.crt | base64 --wrap=1000)\n$ vault kv put kv/quarkus/vault-demo fullchain.crt="$FULL_CHAIN"\n======= Secret Path =======\nkv/data/quarkus/vault-demo\n\n======= Metadata =======\nKey                Value\n---                -----\ncreated_time       2023-12-10T04:28:11.532295585Z\ncustom_metadata    <nil>\ndeletion_time      n/a\ndestroyed          false\nversion            3\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u76f8\u8f03\u65bc ENV \u65b9\u5f0f\uff0cFILE \u65b9\u5f0f\u4e0d\u5fc5\u5ba3\u544a ",(0,r.jsx)(n.code,{children:"secretObjects"})," \u6b04\u4f4d\u3002\u8868\u793a\u5176\u7528\u6a94\u6848\u65b9\u5f0f\u9032\u884c\u639b\u8f09\uff0c\u9019\u908a\u53ef\u4ee5\u770b\u5230\u7684\u662f encoding \u6b04\u4f4d\u4f7f\u7528 base64\uff0c\u8868\u793a\u8981\u5c07 KV \u4e2d fullchain.crt \u9375\u5c0d\u61c9\u7684\u503c\u9032\u884c base64 \u89e3\u78bc\u3002\u4e0b\u9762\u662f\u57fa\u65bc FILE \u65b9\u5f0f\u9032\u884c\u5ba3\u544a\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'# File based\napiVersion: secrets-store.csi.x-k8s.io/v1\nkind: SecretProviderClass\nmetadata:\n  name: quarkus-demo-file\n  labels:\n    app.kubernetes.io/managed-by: "vault"\nspec:\n  provider: vault\n  parameters:\n    roleName: \'quarkus-vault\'\n    vaultAddress: \'http://172.20.0.5:30820\'\n    vaultAuthMountPath: \'quarkus-cluster\'\n    objects: |\n      - objectName: "fullchain.crt"\n        secretPath: "kv/data/quarkus/vault-demo?version=3"\n        secretKey: "fullchain.crt"\n        encoding: "base64"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u540c\u6a23\uff0c\u5728 ",(0,r.jsx)(n.code,{children:"Deployment"})," \u8cc7\u6e90\u7684\u5ba3\u544a\u4e0b\uff0c\u8981\u5c07\u4e0a\u9762\u7684 ",(0,r.jsx)(n.code,{children:"SecretProviderClass"})," \u7269\u4ef6\u9032\u884c\u639b\u8f09\uff0c\u5982\u4e0b\u3002\u9019\u5982\u540c ENV \u65b9\u5f0f\uff0c\u4f46\u56e0\u70ba\u662f FILE \u5f62\u5f0f\u6240\u4ee5\u4e0d\u5fc5\u5ba3\u544a ",(0,r.jsx)(n.code,{children:"env"})," \u6b04\u4f4d\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"...\n          volumeMounts:\n          - name: vault-secret-file\n            mountPath: \"/opt/pki\"\n            readOnly: true\n      volumes:\n      - name: vault-secret-file\n        csi:\n          driver: 'secrets-store.csi.k8s.io'\n          readOnly: true\n          volumeAttributes:\n            secretProviderClass: 'quarkus-demo-file'\n...\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728 ",(0,r.jsx)(n.code,{children:"mountPath"})," \u6b04\u4f4d\u5b9a\u7fa9\u4e86\u8981\u5c07 Vault \u53d6\u51fa\u7684 ",(0,r.jsx)(n.code,{children:"fullchain.crt"})," \u8cc7\u6e90\u653e\u7f6e ",(0,r.jsx)(n.code,{children:"/opt/pki"})," \u8def\u5f91\u4e0b\u3002\u53ef\u900f\u904e\u4e0b\u8ff0\u6307\u4ee4\u9a57\u8b49\uff0c\u4f46\u8981\u5148\u90e8\u7f72 ",(0,r.jsx)(n.code,{children:"kubectl apply -f k8s/deployment-secret-csi.yaml"})," \u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ kubectl exec secret-csi-vault-7b98fd57d5-cjddz -- ls /opt/pki\nfullchain.crt\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u900f\u904e\u7d42\u7aef\u6191\u8b49\u9a57\u8b49\u3002\u9032\u884c API \u9a57\u8b49\uff0c\u4e26\u56de\u61c9 200\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"$ curl -v -k -XPOST --form client=@end-entity.crt https://app.cch.com:8451\n...\n< HTTP/2 200\n< date: Sun, 10 Dec 2023 07:24:50 GMT\n< content-length: 0\n< strict-transport-security: max-age=15724800; includeSubDomains\n<\n* Connection #0 to host app.cch.com left intact\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u4e0a\u9762 ENV \u6216 FILE \u7c21\u6613\u7684\u6d41\u7a0b\u662f kubelet \u5728 Pod volume \u639b\u8f09\u671f\u9593\u8abf\u7528 CSI \u9a45\u52d5\u7a0b\u5f0f\u3002\u56e0\u6b64\uff0c\u5728 Pod \u555f\u52d5\u5f8c\uff0c\u5f8c\u7e8c\u66f4\u6539\u4e0d\u6703\u89f8\u767c\u5c0d\u8a72\u639b\u8f09\u6216 Kubernetes \u91d1\u9470\u4e2d\u5167\u5bb9\u7684\u66f4\u65b0\u3002\u90a3\u9019\u53ef\u80fd\u662f\u7528\u7b2c\u4e09\u65b9\u5957\u4ef6\u50cf\u662f ",(0,r.jsx)(n.a,{href:"https://github.com/stakater/Reloader",children:"Reloader"})," \u6216\u662f\u61c9\u7528\u7a0b\u5f0f\u81ea\u884c\u5be6\u73fe\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u5982\u679c\u4e0a\u9762\u7bc4\u4f8b\u8a2d\u5b9a\u6709\u50cf\u662f\u627e\u4e0d\u5230 Vault \u4e2d\u5b9a\u7fa9\u7684 Key \u554f\u984c\u5247 Pod \u6703\u8655\u65bc ContainerCreating \u72c0\u614b\uff0c\u5982\u4e0b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'$ kubectl get pods -w\nsecret-csi-vault-7b98fd57d5-gmvw6   0/1     ContainerCreating   0          24s\n$ kubectl describe pods secret-csi-vault-7b98fd57d5-gmvw6\n...\n  Normal   Scheduled    116s                default-scheduler  Successfully assigned default/secret-csi-vault-7b98fd57d5-gmvw6 to k3d-quarkus-cluster-agent-0\n  Warning  FailedMount  52s (x8 over 116s)  kubelet            MountVolume.SetUp failed for volume "vault-secret-file" : rpc error: code = Unknown desc = failed to mount secrets store objects for pod default/secret-csi-vault-7b98fd57d5-gmvw6, err: rpc error: code = Unknown desc = error making mount request: {kv/data/quarkus/vault-demo}: {key "fullchain.crt" does not exist at the secret path}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Secrets Store CSI Driver \u5b98\u65b9\u63d0\u4f9b\u4e86\u4e0b\u5716\u67b6\u69cb\u5716\u3002kubelet \u6703\u547c\u53eb Secrets Store CSI Driver\uff0c\u518d\u900f\u904e ",(0,r.jsx)(n.code,{children:"SecretProviderClass"})," \u6aa2\u7d22\u5167\u5bb9\u3002\u4e0d\u904e\u5176\u6703\u96a8\u8457 Pod \u7684\u522a\u9664\u800c\u522a\u9664\uff0c\u4f46\u9019\u4e0d\u898b\u5f97\u662f\u58de\u4e8b\uff0c\u7562\u7adf\u8cc7\u6e90\u5b83\u5e6b\u4f60\u6e05\uff0c\u6e1b\u5c11\u5783\u573e\u8cc7\u6e90\u7684\u5b58\u5728\u3002\u66f4\u591a\u7684\u7d30\u7bc0\u53ef\u81f3\u5b98\u65b9\u9032\u884c",(0,r.jsx)(n.a,{href:"https://secrets-store-csi-driver.sigs.k8s.io/concepts",children:"\u7ffb\u95b1"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:s(4746).Z+"",width:"1656",height:"637"})}),"\n",(0,r.jsx)(n.p,{children:"\u5c0d\u65bc Secrets Store CSI Driver \u57fa\u672c\u4e0a\u652f\u63f4\u6240\u6709 Kubernetes Secret \u985e\u578b\uff0c\u500b\u4eba\u89ba\u5f97\u5c07\u79c1\u6709\u6620\u50cf\u6a94\u5b58\u53d6\u7684\u4ee4\u724c\u4f7f\u7528 base64 \u7de8\u78bc\u4e26\u5c07\u5176\u6574\u5408\u81f3 Vault\uff0c\u6700\u5f8c\u4f7f\u7528 Secrets Store CSI Driver \u5c07\u5176\u79c1\u6709\u93e1\u50cf\u5b58\u53d6\u7684\u4ee4\u724c\u9032\u884c\u6293\u53d6\u4e26\u8f09\u5165\u81f3 Pod \u8b93\u5176\u751f\u547d\u9031\u671f\u7531 Secrets Store CSI Driver \u9032\u884c\u63a7\u7ba1\uff0c\u9019\u6a23\u6e1b\u5c11\u4e86\u4e0d\u5fc5\u8981\u7684\u8cc7\u8a0a\u6d29\u6f0f\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u5230\u9019\u908a\u5f88\u6e05\u695a\u7684\u77e5\u9053 ",(0,r.jsx)(n.code,{children:"SecretProviderClass"})," CRD \u9032\u884c\u5b9a\u7fa9\uff0c\u5176\u63d0\u4f9b\u4e86\u4ecb\u9762\u7d66\u7b2c\u4e09\u65b9\u754c\u63a5\u3002\u900f\u904e\u4e0b\u9762 ",(0,r.jsx)(n.code,{children:"kubectl explain"})," \u4f86\u770b\uff0c\u5176\u63d0\u4f9b ",(0,r.jsx)(n.code,{children:"parameters"})," \u7d66\u7b2c\u4e09\u65b9\u9032\u884c\u4e32\u63a5\uff0c\u56e0\u6b64\u6bcf\u500b\u5be6\u4f5c\u7684\u7b2c\u4e09\u65b9\u90fd\u6703\u5b9a\u7fa9\u7684\u4e0d\u540c\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"$ kubectl explain SecretProviderClass.spec\nGROUP:      secrets-store.csi.x-k8s.io\nKIND:       SecretProviderClass\nVERSION:    v1\n\nFIELD: spec <Object>\n\nDESCRIPTION:\n    SecretProviderClassSpec defines the desired state of SecretProviderClass\n\nFIELDS:\n  parameters    <map[string]string>\n    Configuration for specific provider\n\n  provider      <string>\n    Configuration for provider name\n\n  secretObjects <[]Object>\n    <no description>\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5be6\u969b\u4e0a\u672c\u6587\u7ae0\u7bc4\u4f8b\u5b9a\u7fa9\u7684 ",(0,r.jsx)(n.code,{children:"parameters"}),"\uff0c\u662f\u900f\u904e Vault \u5b98\u65b9\u7684\u898f\u7bc4\u9032\u884c\u8a2d\u5b9a\uff0c\u4e0b\u9762 parameters \u4e0b\u63cf\u8ff0\u7684\u6b04\u4f4d\u90fd\u53c3\u8003\u81f3 Vault \u91dd\u5c0d\u65bc CSI \u7684",(0,r.jsx)(n.a,{href:"https://developer.hashicorp.com/vault/docs/platform/k8s/csi/configurations",children:"\u8a2d\u5b9a"}),"\u3002\u9019\u908a\u4e0b\u9762\u91dd\u5c0d\u4e0a\u9762\u7684\u5be6\u9a57\u5167\u5bb9\u9032\u884c\u7c21\u6613\u7684\u8a2d\u5b9a\u63cf\u8ff0\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'...\n  parameters:\n    roleName: \'quarkus-vault\'\n    vaultAddress: \'http://172.20.0.5:30820\'\n    vaultAuthMountPath: \'quarkus-cluster\'\n    objects: |\n      - objectName: "fullchain.crt"\n        secretPath: "kv/data/quarkus/vault-demo?version=3"\n        secretKey: "fullchain.crt"\n        encoding: "base64"\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"roleName \u767b\u5165 Vault \u6642\u8981\u4f7f\u7528\u7684\u89d2\u8272\u540d\u7a31"}),"\n",(0,r.jsx)(n.li,{children:"vaultAddress Vault \u670d\u52d9\u901a\u8a0a\u4f4d\u7f6e"}),"\n",(0,r.jsx)(n.li,{children:"vaultAuthMountPath Vault \u4e2d\u5b9a\u7fa9 auth \u7684\u8def\u5f91\uff0c\u7528\u65bc\u767b\u5165\u6642\u547c\u53eb\u767b\u5165 API \u8def\u5f91"}),"\n",(0,r.jsx)(n.li,{children:"objects \u6aa2\u7d22 Vault \u8cc7\u6e90"}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"\u7e3d\u7d50",children:"\u7e3d\u7d50"}),"\n",(0,r.jsx)(n.p,{children:"\u672c\u7ae0\u900f\u904e\u55ae\u4e00 Vault \u670d\u52d9\u6574\u5408\u591a\u500b\u53e2\u96c6\uff0c\u4e26\u6574\u5408 Kubernetes \u8eab\u4efd\u9a57\u8b49\u4f86\u8b93 Vault \u5b58\u53d6 Kubernetes \u53e2\u96c6\uff0c\u540c\u6a23\u7684 Vault \u652f\u63f4\u591a\u7a2e\u8a8d\u8b49\uff0c\u53ef\u4f9d\u7167\u5834\u666f\u9032\u884c\u6574\u5408\u3002\u6700\u5f8c\u900f\u904e Secrets Store CSI Driver \u65b9\u5f0f\u5be6\u73fe\u7121\u4fb5\u5165\u65b9\u5f0f\u8b93\u61c9\u7528\u7a0b\u5f0f\u8207 Vault \u9032\u884c\u6574\u5408\u3002\u96d6\u7136\u76ee\u524d\u5c0d\u65bc\u81ea\u52d5\u66f4\u65b0\u652f\u63f4\u5ea6\u4e0d\u662f\u5f88\u597d\uff0c\u4f46\u8a72\u529f\u80fd\u900f\u904e\u793e\u7fa4\u6703\u9010\u6f38\u7a69\u5b9a\uff0c\u4f46\u5176\u5c0d\u65bc\u4e0d\u719f\u6089\u5c08\u6848\u8207 Vault \u6574\u5408\u662f\u4e00\u500b\u597d\u7684\u65b9\u5f0f\u3002\u7576\u7136\uff0cSecrets Store CSI Driver \u4e26\u975e\u662f\u4e00\u7a2e\u552f\u4e00\u7684\u89e3\u6c7a\u65b9\u6848\uff0c\u6703\u9078\u64c7\u4e5f\u8a31\u662f\u5bb9\u6613\u7406\u89e3\u3001\u8a2d\u5b9a\u5bb9\u6613\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"\u53c3\u8003\u8cc7\u6599",children:"\u53c3\u8003\u8cc7\u6599"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://developer.hashicorp.com/vault/docs/auth/kubernetes",children:"Kubernetes - Auth Methods | Vault | HashiCorp Developer"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://secrets-store-csi-driver.sigs.k8s.io/",children:"Secrets Store CSI Driver"})}),"\n"]})]})}function o(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},4746:(e,n,s)=>{s.d(n,{Z:()=>r});const r=s.p+"assets/images/secrets-store-csi-5028c07cd3312afca8e7b1843b60f35b.png"},932:(e,n,s)=>{s.d(n,{Z:()=>r});const r=s.p+"assets/images/vault-integrate-k8s-9d2c29b3e25bd8b216f7a423fd44bf83.png"},1151:(e,n,s)=>{s.d(n,{a:()=>l});var r=s(7294);const t={},a=r.createContext(t);function l(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}}}]);