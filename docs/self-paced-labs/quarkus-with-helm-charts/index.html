<!doctype html>
<html lang="zh-Hant-TW" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-self-paced-labs/quarkus-with-helm-charts/index">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Helm Chart 整合以 Quarkus 為例 | CNTUG Infra Labs 說明文件</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.cloudnative.tw/docs/self-paced-labs/quarkus-with-helm-charts/"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant-TW"><meta data-rh="true" name="docsearch:language" content="zh-Hant-TW"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Helm Chart 整合以 Quarkus 為例 | CNTUG Infra Labs 說明文件"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.cloudnative.tw/docs/self-paced-labs/quarkus-with-helm-charts/"><link data-rh="true" rel="alternate" href="https://docs.cloudnative.tw/docs/self-paced-labs/quarkus-with-helm-charts/" hreflang="zh-Hant-TW"><link data-rh="true" rel="alternate" href="https://docs.cloudnative.tw/docs/self-paced-labs/quarkus-with-helm-charts/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CNTUG Infra Labs 說明文件 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CNTUG Infra Labs 說明文件 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-63LPQ1DDY1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-63LPQ1DDY1",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.dfb3c229.css">
<link rel="preload" href="/assets/js/runtime~main.80c1bcfa.js" as="script">
<link rel="preload" href="/assets/js/main.8f4bcb3a.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/cntug.png" alt="CNTUG" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/cntug.png" alt="CNTUG" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CNTUG Infra Labs 說明文件</b></a><a class="navbar__item navbar__link" href="/intro">Intro</a><a class="navbar__item navbar__link" href="/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/self-paced-labs">Labs</a><a class="navbar__item navbar__link" href="/docs/architecture/network">Architecture</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/usecase">Use Cases</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cloud-native-taiwan/Infra-Labs-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切換淺色/暗黑模式（當前為淺色模式）" aria-label="切換淺色/暗黑模式（當前為淺色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/self-paced-labs">自主學習實驗室</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/network">Network</a><button aria-label="打開/收起側邊欄選單「Network」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/container">Container</a><button aria-label="打開/收起側邊欄選單「Container」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/kubernetes">Kubernetes</a><button aria-label="打開/收起側邊欄選單「Kubernetes」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/self-paced-labs/kops/">OpenStack 上利用 kops 搭建 K8S Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/self-paced-labs/kwok-in-docker/">KWOK in Docker - 體驗上千節點的 K8s 工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/self-paced-labs/vault/">Quarkus 整合 Vault KV 引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/self-paced-labs/quarkus-with-helm-charts/">Helm Chart 整合以 Quarkus 為例</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/kubernetes"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Helm Chart 整合以 Quarkus 為例</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><h1>Helm Chart 整合以 Quarkus 為例</h1><p>Helm 是一個管理 Kubernetes 資源的打包工具，其產出單元可以稱為 <code>charts</code>，類似於容器映像檔或是 Ubuntu 中的 apt 管理工具，因此它是可以被建立或是刪除。其同時也是 CNCF <a href="https://landscape.cncf.io/card-mode?category=application-definition-image-build&amp;grouping=category" target="_blank" rel="noopener noreferrer">Application Definition &amp; Image Build</a> 中的一員。常見類似的有 <a href="https://kustomize.io/" target="_blank" rel="noopener noreferrer">Kustomize</a> 等。</p><p>一般規劃一個服務要部署在 Kubernetes 上時也許會定義如下資源。但對於要退回或是修改都會維護這些大量資源，其對於發布的應用程式沒有版本控制的概念。</p><ul><li>Deployment</li><li>Service</li><li>Ingress</li><li>Secret</li></ul><p>Helm 可以幫助我們完成這些任務，以方便管理應用程式資源和發布的生命週期，並統一管理、配置和更新這些 Kubernetes 的資源檔案</p><ul><li>發布和套用一套模板</li><li>將資源作為一個 charts 來管理</li><li>倉庫儲存這些 charts</li></ul><p>透過本文章會學習到以下：</p><ul><li>使用 charts 管理部署至 Kubernetes 資源</li><li>charts 整合 Kubeconform 驗證 Kubernetes 部署資源</li><li>charts 整合 kube-score 實現 yaml 檔案靜態掃描</li><li>charts 單元測試</li><li>charts 整合 helm-docs 產生文件</li><li>charts 推送以 Docker Hub 中 Registry 為例</li><li>helm 指令使用</li></ul><p>此文章範例來源程式碼可以至此<a href="https://github.com/CCH0124/quarkus-demo/tree/main/helm-demo" target="_blank" rel="noopener noreferrer">連結</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="實驗環境">實驗環境<a class="hash-link" href="#實驗環境" title="標題的直接連結">​</a></h2><ul><li>OS: Windows 11 WSL (Ubuntu 22.04)</li><li>Docker Engine: 23.0.5</li><li>k3d version: v5.4.9</li><li>kubectl version: v1.27.1</li><li>Helm version: v3.11.3</li><li>kube-score version: v1.17.0</li><li>kubeconform version: v0.6.3</li><li>helm-docs version: v1.11.0</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="建立-helm-chart">建立 Helm Chart<a class="hash-link" href="#建立-helm-chart" title="標題的直接連結">​</a></h2><p>使用 <code>helm create &lt;name&gt;</code> 指令建立一個 <code>charts</code>，如下:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm create web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Creating web-app</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此時會建立一些基礎的資源，更詳細的 <code>charts</code> 結構內容可參閱其官方<a href="https://helm.sh/docs/topics/charts/" target="_blank" rel="noopener noreferrer">文件</a>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└── web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── Chart.yaml </span><span class="token comment" style="color:#999988;font-style:italic"># chart 相關資訊(版本號等)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── charts </span><span class="token comment" style="color:#999988;font-style:italic"># 依賴其它 chart 的目錄</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├── templates </span><span class="token comment" style="color:#999988;font-style:italic"># 用來產生 Kubernetes 資源，會與定義的值資源整合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── NOTES.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── _helpers.tpl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── hpa.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── ingress.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── service.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   ├── serviceaccount.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │   └── tests</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │       └── test-connection.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └── values.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>因為範例的應用程式需要 <code>clusterrole</code> 等其它資源，因此有多定義一些資源。<code>charts</code> 基礎資源只是給了部署至 Kubernetes 資源一些基礎結構，應當依照需求自行設計。</p><p><code>_helpers.tpl</code> 這個檔案可以定義共用的模板，以此範例來說定義了一個共用註解區塊的方法，如下。該 <code>web-app.annotation</code> 是方法名稱，其用 <code>define</code> 關鍵字進行定義。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">/* </span><span class="token comment" style="color:#999988;font-style:italic"># 註解區塊</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">common annotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token important">*/</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> define &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app.annotation&quot; </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">org.cch.com/owner</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">org.cch.com/organize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CCH Tech</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>web-app.annotation</code> 將其使用於 <code>deployment.yaml</code> 中的 <code>metadata.annotations</code>，結果如下。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> include &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app.fullname&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> include &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app.labels&quot; . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 4 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> include &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app.annotation&quot; . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 4 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.deploymentAnnotations </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 4 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> if not .Values.autoscaling.enabled </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Values.replicaCount </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> include &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app.selectorLabels&quot; . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 6 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> if .Values.app.properties </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">checksum/config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> include (print $.Template.BasePath &quot;/configmap.yaml&quot;) . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> sha256sum </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.podAnnotations </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 8 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> include &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app.selectorLabels&quot; . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 8 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.imagePullSecrets </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">imagePullSecrets</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 8 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> include &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app.serviceAccountName&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml .Values.podSecurityContext </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 8 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Chart.Name </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml .Values.securityContext </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 12 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;{{ .Values.image.repository }}:{{ .Values.image.tag | default .Chart.AppVersion }}&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Values.image.pullPolicy </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Values.service.port </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KUBE_POD_NAME </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KUBE_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.extraEnv </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 12 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.extraEnvFrom </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">envFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 12 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.livenessProbe </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">livenessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tpl (toYaml .) $ </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 12 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.readinessProbe </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">readinessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> tpl (toYaml .) $ </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 12 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.lifecycle </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">lifecycle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 12 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml .Values.resources </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 12 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.nodeSelector </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">nodeSelector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 8 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.affinity </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">affinity</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 8 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> with .Values.tolerations </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">tolerations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> toYaml . </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> nindent 8 </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊使用 <code>include</code> 函式將其 <code>web-app.annotation</code> 模板引入，並使用 <code>.</code> 將其作為一個值，最後將結果往 <code>indent </code> 函示傳入。Helm 提供多種的模板函數，有興趣者可以至此官方<a href="https://helm.sh/docs/howto/charts_tips_and_tricks/" target="_blank" rel="noopener noreferrer">文件</a>進行查看。</p><p>當模板定義好之後，必須將其填充資料，否則無法正常被 Kubernetes 執行。在預設上會使用 <code>values.yaml</code> 進行填充。</p><p>以上面的 <code>deployment.yaml</code> 模板為例，執行以下，可以看見值被 <code>values.yaml</code> 填充。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># -s 指定某個要被轉譯的模板</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># -f 指定對模板進行填充的 values yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm template ./ -s templates/deployment.yaml -f values.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Source: web-app/templates/deployment.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">apiVersion: apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kind: Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  name: release-name-web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    helm.sh/chart: web-app-0.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/name: web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/instance: release-name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/version: </span><span class="token string" style="color:#e3116c">&quot;1.16.0&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    app.kubernetes.io/managed-by: Helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    org.cch.com/owner: cch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    org.cch.com/organize: CCH Tech</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  replicas: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  selector:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    matchLabels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app.kubernetes.io/name: web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      app.kubernetes.io/instance: release-name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  template:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    metadata:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      annotations:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      checksum/config: 9370cee06587dc819f556fef23ae74570f025b5f5570ab3188bd3007ff0828f0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      labels:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.kubernetes.io/name: web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        app.kubernetes.io/instance: release-name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    spec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serviceAccountName: web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        fsGroup: </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        runAsNonRoot: </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      containers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        - name: web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          securityContext:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            allowPrivilegeEscalation: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            capabilities:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              drop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              - ALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            readOnlyRootFilesystem: </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            runAsGroup: </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            runAsUser: </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          image: </span><span class="token string" style="color:#e3116c">&quot;egistry.hub.docker.com/cch0124/helm-demo:latest&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          imagePullPolicy: IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ports:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              containerPort: </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              protocol: TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          env:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: KUBE_POD_NAME </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              valueFrom: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fieldRef: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  fieldPath: metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            - name: KUBE_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              valueFrom: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                fieldRef: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  fieldPath: metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          livenessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              path: /q/health/live</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              port: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              scheme: HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialDelaySeconds: </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            periodSeconds: </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            successThreshold: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            timeoutSeconds: </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          readinessProbe:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            httpGet:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              path: /q/health/ready</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              port: http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              scheme: HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            initialDelaySeconds: </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            periodSeconds: </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            successThreshold: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            timeoutSeconds: </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          lifecycle:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            preStop:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              exec:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                command:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - </span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - -c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                - </span><span class="token function" style="color:#d73a49">sleep</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          resources:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            limits:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cpu: 100m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              memory: 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requests:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              cpu: 10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              memory: 256Mi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Helm 透過這種設計做到了 Kubernetes 原生無法管理 <code>yaml</code> 的問題。到這邊可以了解模板如何轉譯，但在轉譯前可以對 <code>charts</code> 進行格式上驗證，驗證模板中的格式是否正確，但此階段無法確保轉譯出來的 Kubernetes 資源可被使用。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm lint ./ -f values.yaml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> Linting ./</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> Chart.yaml: icon is recommended</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> chart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> linted, </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> chart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> failed</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="helm-charts-整合-kubeconform">Helm charts 整合 Kubeconform<a class="hash-link" href="#helm-charts-整合-kubeconform" title="標題的直接連結">​</a></h2><p>當一個 <code>charts</code> 被定義好之後，應當驗證其模板轉譯出來 <code>yaml</code> 的完整性。<a href="https://github.com/yannh/kubeconform" target="_blank" rel="noopener noreferrer">Kubeconform</a> 是一個驗證工具 Kubernetes <code>yaml</code> 資源的工具，可以將其導入 CI 流程。</p><p>本實驗是用 ubuntu 環境直接安裝，其它方式可參閱此<a href="https://github.com/yannh/kubeconform#installation" target="_blank" rel="noopener noreferrer">連結</a></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/yannh/kubeconform/releases/download/v0.6.3/kubeconform-linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kubeconform-linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> kubeconform /usr/local/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>驗證方式很簡單的使用，可以透過 <code>helm template</code> 產生出期望的部署的 <code>yaml</code> 檔案，再透過 <code>Kubeconform</code> 驗證。</p><p>驗證過程會建議，指定 Kubernetes 版本來進行驗證，Kubernetes 每個版本的 API 會有所不同，這樣可以明確知道 <code>charts</code> 可以在哪個環境運行。避免 Kubernetes 升級後帶來的災難。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm template --skip-tests --kube-version v1.23.0 ./ -f ci/values-analysis.yaml </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kubeconform --summary -kubernetes-version </span><span class="token number" style="color:#36acaa">1.23</span><span class="token plain">.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Summary: </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> resources found parsing stdin - Valid: </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">, Invalid: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, Errors: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, Skipped: </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果此時，想使用 1.26.0 版本的 Kubernetes 環境驗證會發現錯誤。這是因為 1.23.0 版本支援 <code>autoscaling/v2beta1</code>，但 1.26.0 官方認為他已經可以穩定運行所以變更為 <code>autoscaling/v2</code>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm template --skip-tests --kube-version v1.26.0 ./ -f ci/values-analysis.yaml </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kubeconform --summary -kubernetes-version </span><span class="token number" style="color:#36acaa">1.26</span><span class="token plain">.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">stdin - HorizontalPodAutoscaler release-name-web-app failed validation: could not </span><span class="token function" style="color:#d73a49">find</span><span class="token plain"> schema </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Summary: </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> resources found parsing stdin - Valid: </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">, Invalid: </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">, Errors: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">, Skipped: </span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這驗證結果要有更詳細的內容可以加入 <code>-output</code> 參數來指定格式，其支援的有 json、junit 與 tap，而 text 為預設 </p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm template --skip-tests ./ -f ci/values-analysis.yaml </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kubeconform -kubernetes-version </span><span class="token number" style="color:#36acaa">1.23</span><span class="token plain">.0  -output junit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testsuites </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;kubeconform&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;1.137183422&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">tests</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;8&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">failures</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">disabled</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">errors</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testsuite </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;stdin&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">id</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">tests</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;8&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">failures</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">errors</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">disabled</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">skipped</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;release-name-web-app&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;ConfigMap@v1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;default/release-name-web-app&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;ClusterRole@rbac.authorization.k8s.io/v1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;release-name-web-app&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;ClusterRoleBinding@rbac.authorization.k8s.io/v1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;web&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;ServiceAccount@v1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;release-name-web-app&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Service@v1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;release-name-web-app&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Ingress@networking.k8s.io/v1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;release-name-web-app&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;HorizontalPodAutoscaler@autoscaling/v2beta1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">testcase </span><span class="token assign-left variable" style="color:#36acaa">name</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;release-name-web-app&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">classname</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Deployment@apps/v1&quot;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">time</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;0&quot;</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testcase</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testsuite</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">/testsuites</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊簡易了使用其 <code>kubeconform</code> 操作，預設上環境常常可能會有非原始 Kubernetes 資源的 CRD，如果要做驗證的話可以 <code>-ignore-missing-schemas</code> 掉或是用 <code>-schema-location</code> 方式去做處理這部分可以參閱<a href="https://github.com/yannh/kubeconform#overriding-schemas-location" target="_blank" rel="noopener noreferrer">連結</a>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="helm-charts-整合-kube-score">Helm charts 整合 kube-score<a class="hash-link" href="#helm-charts-整合-kube-score" title="標題的直接連結">​</a></h2><p>對於驗證 <code>yaml</code> 完整性來說可能還不夠，如果想要進階的對物件資源進行驗證可以使用 <a href="https://github.com/zegl/kube-score" target="_blank" rel="noopener noreferrer">kube-score</a> 來實現，其輸出內容會是推薦可實踐的內容，可能相關於安全部分或是可靠性部分。同樣的可以將其導入 CI 流程來強化 charts 所轉譯物件是否夠強壯。</p><p>本實驗是用 ubuntu 環境直接安裝，如下:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">wget</span><span class="token plain"> https://github.com/zegl/kube-score/releases/download/v1.17.0/kube-score_1.17.0_linux_amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">tar</span><span class="token plain"> xf kube-score_1.17.0_linux_amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">sudo</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mv</span><span class="token plain"> kube-score /usr/local/bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>有興趣者可以藉由<a href="https://kube-score.com/" target="_blank" rel="noopener noreferrer">官方網站</a>位置進行體驗。</p><p>這邊同樣的用 <code>helm template</code> 方式產生 <code>yaml</code> 資源，並透過 <code>kube-score</code> 進行掃描</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm template --skip-tests --kube-version v1.23.0 ./ -f ci/values-analysis.yaml </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-score score --kubernetes-version </span><span class="token string" style="color:#e3116c">&quot;v1.23&quot;</span><span class="token plain"> -o ci -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-ephemeral-storage-request-equals-limit is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Pod Topology Spread Constraints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-memory-requests-equal-limits is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">web-app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Ephemeral Storage limit is not </span><span class="token builtin class-name">set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-ports-check is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">web-app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> The container is running with a low user ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">web-app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> The container running with a low group ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">web-app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> The pod has a container with a writable root filesystem</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-seccomp-profile is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">web-app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> ImagePullPolicy is not </span><span class="token builtin class-name">set</span><span class="token plain"> to Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: The pod does not have a matching NetworkPolicy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-resource-requests-equal-limits is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-cpu-requests-equal-limits is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">web-app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> Image with latest tag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CRITICAL</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: No matching PodDisruptionBudget was found</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Deployment does not have a </span><span class="token function" style="color:#d73a49">host</span><span class="token plain"> podAntiAffinity </span><span class="token builtin class-name">set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app autoscaling/v2beta1/HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app autoscaling/v2beta1/HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app autoscaling/v2beta1/HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app networking.k8s.io/v1/Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app networking.k8s.io/v1/Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app networking.k8s.io/v1/Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊發現一些 <code>CRITICAL</code> 訊息，這表示 <code>kube-score</code> 建議你要做像是不使用 latest 映像檔標籤或是希望有 <code>PodDisruptionBudget</code> 的物件等。在 CI 中出現了 <code>CRITICAL</code> 會是以不通過收場。如果假設在環境上沒有打算實現 <code>PodDisruptionBudget</code> 或是 <code>NetworkPolicy</code> 資源，我們可以透過 <code>--disable-ignore-checks-annotations</code> 或是 Kubernetes 中 <code>annotations</code> 欄位使用 <code>kube-score/ignore</code> 來實現必驗證的動作，官方提供的<a href="https://github.com/zegl/kube-score/blob/master/README_CHECKS.md" target="_blank" rel="noopener noreferrer">清單</a>。</p><p>這邊在 <code>ci/values-analysis.yaml</code> 多新增了以下的定義來決策 <code>kube-score</code> 要啟用哪些檢查或是關閉檢查，已關閉來說避開了 <code>NetworkPolicy</code>、<code>securityContext</code> 的 user 和 group ID 檢查。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">deploymentAnnotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kube-score/ignore</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">networkpolicy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">container</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">security</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">container</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">security</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">readonlyrootfilesystem</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">container</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ephemeral</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">storage</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">and</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">deployment</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">has</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">poddisruptionbudget</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">kube-score/enable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> container</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">ports</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">check</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後，在驗證一次沒有出現 <code>CRITICAL</code> 警告，就可以通過檢查。要關閉什麼檢查，這取決於團隊設計的架構，也不應當略過一些基本的檢查像是 <code>securityContext</code> 設定。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm template --skip-tests --kube-version v1.23.0 ./ -f ci/values-analysis.yaml </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> kube-score score --kubernetes-version </span><span class="token string" style="color:#e3116c">&quot;v1.23&quot;</span><span class="token plain"> -o ci -</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-resource-requests-equal-limits is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because pod-networkpolicy is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-security-context-user-group-id is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-security-context-readonlyrootfilesystem is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-seccomp-profile is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-memory-requests-equal-limits is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-ephemeral-storage-request-equals-limit is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Pod Topology Spread Constraints</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-cpu-requests-equal-limits is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because container-ephemeral-storage-request-and-limit is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">SKIPPED</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Skipped because deployment-has-poddisruptionbudget is ignored</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">WARNING</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment: Deployment does not have a </span><span class="token function" style="color:#d73a49">host</span><span class="token plain"> podAntiAffinity </span><span class="token builtin class-name">set</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app apps/v1/Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app autoscaling/v2beta1/HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app autoscaling/v2beta1/HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app autoscaling/v2beta1/HorizontalPodAutoscaler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app networking.k8s.io/v1/Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app networking.k8s.io/v1/Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app networking.k8s.io/v1/Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">OK</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> release-name-web-app v1/Service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="charts-單元測試">charts 單元測試<a class="hash-link" href="#charts-單元測試" title="標題的直接連結">​</a></h2><p>上面驗證了 <code>charts</code> 和 <code>yaml</code> 資源，如果想更要在貼近一點現實可以透過單元測試方式驗證轉譯的物件內容是不是你期望在 Kubernets 上運行的內容。這邊使用 <a href="https://github.com/helm-unittest/helm-unittest" target="_blank" rel="noopener noreferrer">helm-unittest</a> 套件來進行單元測試。</p><p>他屬於 Helm 的套件，因此可以使用 <code>helm plugin</code> 方式安裝</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm plugin </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> https://github.com/helm-unittest/helm-unittest.git</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>一開始在 <code>charts</code> 的目錄下建立 <code>tests</code> 目錄，並把該目錄新增自 <code>.helmignore</code> 中。要觸發測試可以使用 <code>helm unittest CHART_NAME</code>下面是一個測試完成的結果，預設格式是 <code>XUnit</code>，這可以使用 <code>-t</code> 參數進行替換，可以是 JUnit、NUnit 或 XUnit。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm unittest web-app/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">### Chart [ web-app ] web-app/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PASS  </span><span class="token builtin class-name">test</span><span class="token plain"> cluster role        web-app/tests/clusterrole_test.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PASS  </span><span class="token builtin class-name">test</span><span class="token plain"> clusterrolebinding  web-app/tests/clusterrolebinding_test.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PASS  </span><span class="token builtin class-name">test</span><span class="token plain"> configMap   web-app/tests/configmap_test.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PASS  </span><span class="token builtin class-name">test</span><span class="token plain"> deployment  web-app/tests/deployment_test.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PASS  </span><span class="token builtin class-name">test</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">service</span><span class="token plain">     web-app/tests/service_test.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> PASS  </span><span class="token builtin class-name">test</span><span class="token plain"> serviceAccount      web-app/tests/serviceaccount_test.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Charts:      </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> passed, </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> total </span><span class="token comment" style="color:#999988;font-style:italic"># 表示一個 charts 被測試</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Test Suites: </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> passed, </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> total </span><span class="token comment" style="color:#999988;font-style:italic"># 測試的場景有 6 個，通過 6 個</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tests:       </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> passed, </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Snapshot:    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> passed, </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Time:        </span><span class="token number" style="color:#36acaa">12</span><span class="token plain">.111921ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果要將結果輸出至 <code>CI</code> 的產物可以使用 <code>-o FILE_NAME</code> 方式，輸出的檔案會取決於在哪個目錄執行 <code>helm unittest</code>。</p><p>下面是一個測試 <code>deployment.yaml</code> 的內容。在 <code>asserts</code> 中用了 <code>equal</code>、<code>isNotEmpty</code>、<code>contains</code> 等關鍵字，但重點在於 <code>path</code> 其就是用來對應真實部署資源的欄位。</p><ul><li>path: 會是參照 Kubernetes 物件資源上內容，通常會精準指向某個物件中欄位。可以想像是透過 <code>kubectl get</code> 某物件然後使用 <code>jsonpath</code> 來自定義輸出。</li><li>value: 期望 path 上的值，但這通常用於 Kubernetes 上的欄位指對應一個值使用。</li><li>content: 類似於 path，但應用於多輸出的內容。</li></ul><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">suite</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">values</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 測試時要使用的 values yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ../ci/values</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">test.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">templates</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 要被測試的模板</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> templates/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> templates/configmap.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">release</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 模擬 charts 部署時的內容</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">release</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">chart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 模擬 charts 的版本和 app 版本</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  0.1.0+test</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">appVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.16.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">tests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">it</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> should pass all kinds of assertion</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> templates/deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">documentIndex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">asserts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.labels</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;app.kubernetes.io/managed-by&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Helm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.labels</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;app.kubernetes.io/name&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.annotations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;org.cch.com/owner&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.annotations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;org.cch.com/organize&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> CCH Tech</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isNotEmpty</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.metadata.annotations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;checksum/config&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.image</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.hub.docker.com/cch0124/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v2.2.9</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">equal</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.serviceAccountName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> web</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">matchRegex</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">pattern</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ^.</span><span class="token important">*-web-app$</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">contains</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.ports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">content</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">protocol</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TCP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">notContains</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.ports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">content</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">containerPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isNotEmpty</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.livenessProbe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isNotEmpty</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.readinessProbe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isNotEmpty</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.resources</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isSubset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.securityContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">content</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">capabilities</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">drop</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ALL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">readOnlyRootFilesystem</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">allowPrivilegeEscalation</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">runAsUser</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">runAsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isNotEmpty</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.containers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">(@.name == &quot;web</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">app&quot;)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.lifecycle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isSubset</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> spec.template.spec.securityContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">content</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">fsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">runAsNonRoot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isKind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">of</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">isAPIVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">of</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更多的細節可以參照 helm-unittest 官方<a href="https://github.com/helm-unittest/helm-unittest/blob/main/DOCUMENT.md" target="_blank" rel="noopener noreferrer">文件</a>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="charts-整合-helm-docs-產生文件">charts 整合 helm-docs 產生文件<a class="hash-link" href="#charts-整合-helm-docs-產生文件" title="標題的直接連結">​</a></h2><p>是一個將 <code>charts</code> 中的資訊轉譯成 markdown 檔案的工具。生成的內容包含了 <code>Chart.yaml</code> 中的一些資訊或是 <code>values.yaml</code> 中定義的值內容，該內容會使用註解來進行解析。</p><p>轉譯 markdown 這流程是從 gotemplate 實作，相似於 <code>charts</code> 模板。預設上 helm-docs 有基本的樣式來做轉譯，當然也可以透過 <code>README.md.gotmpl</code> 檔案進行轉譯內容的定義。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># {{ template &quot;chart.name&quot; . }}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag" style="color:#00009f">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Version </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//img.shields.io/badge/Version</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Version </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> replace &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">informational</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">style=for</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">the</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">badge)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> if .Type </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token key atrule" style="color:#00a4db">Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Type </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//img.shields.io/badge/Type</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Type </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">informational</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">style=for</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">the</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">badge) </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> if .AppVersion </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token key atrule" style="color:#00a4db">AppVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .AppVersion </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//img.shields.io/badge/AppVersion</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .AppVersion </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> replace &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">informational</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">style=for</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">the</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">badge) </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## {{ template &quot;chart.name&quot; . }} Chart Information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Homepage</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.homepage&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.sourcesSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.maintainersSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## Description</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.description&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.requirementsSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.valuesSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>helm-docs</code> 的指令允許用 <code>-t</code> 指定模板檔案或是 <code>-f</code> 指定到 <code>charts</code> 中預設的 <code>values.yaml</code> 等，下方為指令所提供的參數。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm-docs --help</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm-docs automatically generates markdown documentation </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> helm charts from requirements and values files</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Usage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  helm-docs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flags:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -b, --badge-style string           badge style to use </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> charts </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token string" style="color:#e3116c">&quot;flat-square&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -c, --chart-search-root string     directory to search recursively within </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> charts </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token string" style="color:#e3116c">&quot;.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -g, --chart-to-generate strings    List of charts that will have documentation generated. Comma separated, no space. Empty list - generate </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> all charts </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> chart-search-root</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -u, --document-dependency-values   For charts with dependencies, include the dependency values </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the chart values documentation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d, --dry-run                      don&#x27;t actually render any markdown files just print to stdout passed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -h, --help                         </span><span class="token builtin class-name">help</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> helm-docs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -i, --ignore-file string           The filename to use as an ignore </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> to exclude chart directories </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token string" style="color:#e3116c">&quot;.helmdocsignore&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --ignore-non-descriptions      ignore values without a comment, this values will not be included </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> the README</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -l, --log-level string             Level of logs that should printed, one of </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">panic, fatal, error, warning, info, debug, trace</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token string" style="color:#e3116c">&quot;info&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -o, --output-file string           markdown </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> path relative to each chart directory to </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> rendered documentation will be written </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token string" style="color:#e3116c">&quot;README.md&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -s, --sort-values-order string     order </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> to </span><span class="token function" style="color:#d73a49">sort</span><span class="token plain"> the values table </span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;alphanum&quot;</span><span class="token plain"> or </span><span class="token string" style="color:#e3116c">&quot;file&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token string" style="color:#e3116c">&quot;alphanum&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -t, --template-files strings       gotemplate </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> paths relative to each chart directory from </span><span class="token function" style="color:#d73a49">which</span><span class="token plain"> documentation will be generated </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">README.md.gotmpl</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -f, --values-file string           Path to values </span><span class="token function" style="color:#d73a49">file</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">default </span><span class="token string" style="color:#e3116c">&quot;values.yaml&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      --version                      version </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> helm-docs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>helm-docs</code> 中可定義的轉譯模板可參考此官方<a href="https://github.com/norwoodj/helm-docs#markdown-rendering" target="_blank" rel="noopener noreferrer">連結</a>，對於轉譯來說比較重要的參數是 <code>--chart-search-root</code> 和 <code>--template-files</code> 如果其提供的預設值不符合場景設計可以進行靈活上的調整。</p><p>下面是定義後的 <code>READEM.md.gotmpl</code>，使用上比較麻煩的部分就是 gotemplate 的語法，其它基本上看官方的文檔內容就可以組合出自己想要的格式內容。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># {{ template &quot;chart.name&quot; . }}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag" style="color:#00009f">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token key atrule" style="color:#00a4db">Version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Version </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//img.shields.io/badge/Version</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Version </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> replace &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">informational</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">style=for</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">the</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">badge)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> if .Type </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token key atrule" style="color:#00a4db">Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Type </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//img.shields.io/badge/Type</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .Type </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">informational</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">style=for</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">the</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">badge) </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> if .AppVersion </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token tag" style="color:#00009f">!</span><span class="token punctuation" style="color:#393A34">[</span><span class="token key atrule" style="color:#00a4db">AppVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .AppVersion </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//img.shields.io/badge/AppVersion</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> .AppVersion </span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain"> replace &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; &quot;</span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">&quot; </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">informational</span><span class="token punctuation" style="color:#393A34">?</span><span class="token plain">style=for</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">the</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">badge) </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> end </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## {{ template &quot;chart.name&quot; . }} Chart Information</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Homepage</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.homepage&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.sourcesSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.maintainersSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">## Description</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.description&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.requirementsSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> template &quot;chart.valuesSection&quot; . </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>上述的 <code>READEM.md.gotmpl</code> 比較重要的內容是 <code>values.yaml</code> 中所定義的值，因為這是給使用或是管理 <code>charts</code> 的人來做一個依據的參考。雖然透過 <code>chart.valuesSection</code> 模板來解析 <code>values.yaml</code> 內容，但如過沒針對 <code>values.yaml</code> 進行處理，則該模板也是沒意義的。那要如何定義有價值的內容呢，下面就來進行說明吧。</p><p>以 <code>image</code> 結構來說，在 <code>values.yaml</code> 中定義了以下內容</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># -- Image registry</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">repository</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.hub.docker.com/cch0124/helm</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># -- Image pull policy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">pullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> IfNotPresent</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># -- Overrides the image tag whose default is the chart appVersion.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">tag</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;latest&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>該內容上如果要讓欄位有描述，則可以在該欄位上以 <code># --</code> 開頭並向後填寫要描述的註解，最後轉譯結果會如下</p><table><thead><tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>image.pullPolicy</td><td>string</td><td><code>&quot;IfNotPresent&quot;</code></td><td>Image pull policy</td></tr><tr><td>image.repository</td><td>string</td><td><code>&quot;registry.hub.docker.com/cch0124/helm-demo&quot;</code></td><td>Image registry</td></tr><tr><td>image.tag</td><td>string</td><td><code>&quot;latest&quot;</code></td><td>Overrides the image tag whose default is the chart appVersion.</td></tr></tbody></table><p>如果在 <code>values.yaml</code> 是沒有撰寫註解格式，則最後葉節點會被轉譯出來，但是描述部分就有些許空虛了。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">rbac</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">create</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>轉譯結果：</p><table><thead><tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>rbac.create</td><td>bool</td><td><code>true</code></td><td></td></tr></tbody></table><p>如果在 <code>values.yaml</code> 的根節點欄位撰寫註解，則葉節點不會被轉譯，會以根節點物件呈現。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># -- Resource requests and limits for the application. Ref [kubernetes doc manage-resources-containers](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">resources</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">limits</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 100m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 256Mi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">requests</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">cpu</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 10m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">memory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 256Mi</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>轉譯結果：</p><table><thead><tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>resources</td><td>object</td><td><code>{&quot;limits&quot;:{&quot;cpu&quot;:&quot;100m&quot;,&quot;memory&quot;:&quot;256Mi&quot;},&quot;requests&quot;:{&quot;cpu&quot;:&quot;10m&quot;,&quot;memory&quot;:&quot;256Mi&quot;}}</code></td><td>Resource requests and limits for the application. Ref <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/" target="_blank" rel="noopener noreferrer">kubernetes doc manage-resources-containers</a></td></tr></tbody></table><p>如果在 <code>values.yaml</code> 的根節點和葉節點定義註解如下，則葉節點有被註解會被轉譯，否則不會。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># -- Configure the healthcheck for the application</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">livenessProbe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">httpGet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># -- This is the liveness check endpoint. Can not overrid.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /q/health/live</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">scheme</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTTP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># @default -- Number of seconds after the container has started before startup, liveness or readiness probes are initiated. </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">initialDelaySeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># @default -- How often (in seconds) to perform the probe.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">periodSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># @default -- Minimum consecutive successes for the probe to be considered successful after having failed.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">successThreshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># @default -- Number of seconds after which the probe times out. Defaults to 1 second. Minimum value is 1.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">timeoutSeconds</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>轉譯結果：</p><table><thead><tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td>livenessProbe</td><td>object</td><td><code>{&quot;httpGet&quot;:{&quot;path&quot;:&quot;/q/health/live&quot;,&quot;port&quot;:&quot;http&quot;,&quot;scheme&quot;:&quot;HTTP&quot;},&quot;initialDelaySeconds&quot;:60,&quot;periodSeconds&quot;:30,&quot;successThreshold&quot;:1,&quot;timeoutSeconds&quot;:10}</code></td><td>Configure the healthcheck for the application</td></tr><tr><td>livenessProbe.httpGet.path</td><td>string</td><td><code>&quot;/q/health/live&quot;</code></td><td>This is the liveness check endpoint. Can not overrid.</td></tr></tbody></table><p>其還提供 <code>@default</code>、和 <code>@ignored</code> 等選項</p><ul><li><code>@default</code> 如果不想包含在 values.yaml 中的預設值，或是一些計算的值可以使用</li><li><code>@ignored</code> 忽略某些值</li></ul><p>整體來說你可以使用 <code>helm-docs</code> 產生一個可讀性的文件檔案，在某種程度上可以協助部署或是交接。但具體要如何呈現想要的內容則取決於團隊的共識。本文章範例的結果可以至此<a href="https://github.com/CCH0124/quarkus-demo/blob/main/helm-demo/helm-chart/web-app/README.md" target="_blank" rel="noopener noreferrer">連結</a></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="打包-charts-至-dockerhub">打包 charts 至 DockerHub<a class="hash-link" href="#打包-charts-至-dockerhub" title="標題的直接連結">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="打包-charts">打包 charts<a class="hash-link" href="#打包-charts" title="標題的直接連結">​</a></h3><p>切換目錄至 <code>charts</code> 並使用 <code>helm package</code> 對 <code>charts</code> 進行打包，執行後當前目錄會有一個 <code>CHART_NAME-VERSION.tgz</code>  檔案。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm package --version </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.1 ./</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="登入-docker-hub-並推送">登入 Docker Hub 並推送<a class="hash-link" href="#登入-docker-hub-並推送" title="標題的直接連結">​</a></h3><p>登入部分使用 Docker Hub 的 Personal Access Token (PAT) 進行，也推薦使用此方式。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">PAT</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">PERSONAL_ACCESS_TOKEN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">USERNAME</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">LOGIN_USERNAME</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$PAT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">|</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">docker</span><span class="token plain"> login -u </span><span class="token variable" style="color:#36acaa">$USERNAME</span><span class="token plain"> --password-stdin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>推送 <code>charts</code> 至 Docker Hub，使用 <code>helm push</code> 並指定要推送的 <code>charts</code> 和推送目標。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm push web-app-0.0.1.tgz oci://registry-1.docker.io/cch0124</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pushed: registry-1.docker.io/cch0124/web-app:0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Digest: sha256:10b324b17dc620974f715fd44e6743dbd068a6e0487d496a76d2781c81184199</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="部署與操作-helm-charts">部署與操作 Helm charts<a class="hash-link" href="#部署與操作-helm-charts" title="標題的直接連結">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="部署">部署<a class="hash-link" href="#部署" title="標題的直接連結">​</a></h3><p>上個章節已經將 <code>charts</code> 推送至 Docker Hub 接著將使用它來拉取 <code>charts</code> 並部署至模擬的 Kubernetes 環境。</p><p>部署之前，可以藉由 <code>helm show</code> 來進行一些資訊查看。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 查看 charts 所有訊息</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm show all oci://registry-1.docker.io/cch0124/web-app --version </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>直接進行部署，透過 <code>helm install</code>，預設為 <code>default</code> 的 <code>namespace</code>，下面資訊為部署後資料。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> web-app oci://registry-1.docker.io/cch0124/web-app --version </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pulled: registry-1.docker.io/cch0124/web-app:0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Digest: sha256:10b324b17dc620974f715fd44e6743dbd068a6e0487d496a76d2781c81184199</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME: web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Mon Sep </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:57:10 </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: deployed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REVISION: </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TEST SUITE: None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">. Get the application URL by running these commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">POD_NAME</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pods --namespace default -l </span><span class="token variable string" style="color:#e3116c">&quot;app.kubernetes.io/name=web-app,app.kubernetes.io/instance=web-app&quot;</span><span class="token variable" style="color:#36acaa"> -o </span><span class="token variable assign-left variable" style="color:#36acaa">jsonpath</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{.items[0].metadata.name}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">CONTAINER_PORT</span><span class="token operator" style="color:#393A34">=</span><span class="token variable" style="color:#36acaa">$(</span><span class="token variable" style="color:#36acaa">kubectl get pod --namespace default $POD_NAME -o </span><span class="token variable assign-left variable" style="color:#36acaa">jsonpath</span><span class="token variable operator" style="color:#393A34">=</span><span class="token variable string" style="color:#e3116c">&quot;{.spec.containers[0].ports[0].containerPort}&quot;</span><span class="token variable" style="color:#36acaa">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token builtin class-name">echo</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Visit http://127.0.0.1:8080 to use your application&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  kubectl --namespace default port-forward </span><span class="token variable" style="color:#36acaa">$POD_NAME</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">:</span><span class="token variable" style="color:#36acaa">$CONTAINER_PORT</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>驗證部署結果與應用程式測試 API。</p><ol><li>驗證部署</li></ol><p>對於 Helm 來說它是有 namespace 概念，因此在操作時須帶 <code>namespace</code>，從 <code>STATUS</code> 欄位可以看到是成功部署的。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm list </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    NAMESPACE       REVISION        UPDATED                                 STATUS          CHART           APP VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">web-app default         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-09-11 </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:57:10.735141112 +0800 CST deployed        web-app-0.0.1   </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0     </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 <code>kubectl get</code> 資源驗證是否有正常運行。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get pods </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                       READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">web-app-69d997c6ff-wvbwd   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          3m18s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>測試 API</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl run mycurlpod --image</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">curlimages/curl -i --tty -- </span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> -XGET http://web-app.default.svc.cluster.local:8080/hello</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hello from RESTEasy Reactive</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="更新-helm-chart">更新 Helm chart<a class="hash-link" href="#更新-helm-chart" title="標題的直接連結">​</a></h3><p>上個步驟在部署時，沒有部署到 <code>ingress</code>，這時使用 <code>helm upgrade</code> 進行。</p><p>下面為一個錯誤的更新，導致最後 <code>STATUS</code> 為 <code>failed</code>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm upgrade web-app oci://registry-1.docker.io/cch0124/web-app --version </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.1 --set ingress.enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true --set ingress.hosts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">helm-demo.cch.com --set ingress.hosts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.paths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.pathType</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Prefix</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pulled: registry-1.docker.io/cch0124/web-app:0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Digest: sha256:10b324b17dc620974f715fd44e6743dbd068a6e0487d496a76d2781c81184199</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Error: UPGRADE FAILED: failed to create resource: Ingress.extensions </span><span class="token string" style="color:#e3116c">&quot;web-app&quot;</span><span class="token plain"> is invalid: spec.rules</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.http.paths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.path: Invalid value: </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> must be an absolute path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    NAMESPACE       REVISION        UPDATED                                 STATUS  CHART           APP VERSION</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">web-app default         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">               </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-09-11 </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">:18:27.328839062 +0800 CST failed  web-app-0.0.1   </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>修正後，已經成功更新一個版本，<code>REVISION</code> 變為 3，<code>ingress</code> 資源也被更新部署。在做更新時也推薦使用 <code>--atomic</code> 參數，這可幫助 <code>charts</code> 更新失敗後可以進行退回上一個版本。這邊使用的是 <code>--set</code> 方式同時也是可以使用 <code>-f</code> 來指定要轉譯模板的值，以優先順序來說 <code>--set</code> 為最高。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm upgrade web-app oci://registry-1.docker.io/cch0124/web-app --version </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">.1 --set ingress.enabled</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true --set ingress.hosts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">helm-demo.cch.com --set ingress.hosts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.paths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.pathType</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">Prefix --set ingress.hosts</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.paths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.path</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">/ --atomic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Pulled: registry-1.docker.io/cch0124/web-app:0.0.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Digest: sha256:10b324b17dc620974f715fd44e6743dbd068a6e0487d496a76d2781c81184199</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Release </span><span class="token string" style="color:#e3116c">&quot;web-app&quot;</span><span class="token plain"> has been upgraded. Happy Helming</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME: web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LAST DEPLOYED: Mon Sep </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">:21:14 </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAMESPACE: default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">STATUS: deployed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REVISION: </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TEST SUITE: None</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NOTES:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">. Get the application URL by running these commands:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  http://helm-demo.cch.com/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更新後所建立的 <code>ingress</code>。同時在外部可以透過 <code>curl</code> 存取服務。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME      CLASS     HOSTS               ADDRESS                 PORTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">web-app   traefik   helm-demo.cch.com   </span><span class="token number" style="color:#36acaa">172.20</span><span class="token plain">.0.2,172.20.0.3   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      84s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://helm-demo.cch.com:8080/cluster/namespace </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;kube-system&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;kube-public&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;kube-node-lease&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="回滾-charts">回滾 charts<a class="hash-link" href="#回滾-charts" title="標題的直接連結">​</a></h3><p>上個步驟暴露了 <code>API</code> 至 Kubernetes 集群外，如果想要讓其回到第一次無 <code>ingress</code> 狀態，可以使用 <code>helm rollback</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm rollback web-app </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">App: </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0, Chart: web-app-0.0.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">App: </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0, Chart: web-app-0.0.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">App: </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0, Chart: web-app-0.0.1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>此時會多一個版本，詳細的資訊使用 <code>helm history</code>，且 <code>ingress</code> 也回到第一版本狀態。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm </span><span class="token function" style="color:#d73a49">history</span><span class="token plain"> web-app</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">REVISION        UPDATED                         STATUS          CHART           APP VERSION     DESCRIPTION                                                                                                                                                                </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">1</span><span class="token plain">               Mon Sep </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">:57:10 </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">        superseded      web-app-0.0.1   </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0          Install complete                                                                                                                                                           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">2</span><span class="token plain">               Mon Sep </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">:18:27 </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">        failed          web-app-0.0.1   </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0          Upgrade </span><span class="token string" style="color:#e3116c">&quot;web-app&quot;</span><span class="token plain"> failed: failed to create resource: Ingress.extensions </span><span class="token string" style="color:#e3116c">&quot;web-app&quot;</span><span class="token plain"> is invalid: spec.rules</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.http.paths</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">.path: Invalid value: </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token builtin class-name">:</span><span class="token plain"> must be an absolute path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">3</span><span class="token plain">               Mon Sep </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">:21:14 </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">        superseded      web-app-0.0.1   </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0          Upgrade complete                                                                                                                                                           </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">4</span><span class="token plain">               Mon Sep </span><span class="token number" style="color:#36acaa">11</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">21</span><span class="token plain">:31:32 </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">        deployed        web-app-0.0.1   </span><span class="token number" style="color:#36acaa">1.16</span><span class="token plain">.0          Rollback to </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>驗證結果，如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">No resources found </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> default namespace.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl </span><span class="token builtin class-name">exec</span><span class="token plain"> mycurlpod  -it /bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ $ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://web-app.default.svc.cluster.local:8080/pod/list/name?namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;web-app-69d997c6ff-wvbwd&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;mycurlpod&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">~ $ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://web-app.default.svc.cluster.local:8080/pod/list/name?namespace</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kube-system</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;helm-install-traefik-crd-jgf8d&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;helm-install-traefik-hpt7l&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;svclb-traefik-c047adea-n9grs&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;traefik-6468fd4675-v56h5&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;svclb-traefik-c047adea-8phnq&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;local-path-provisioner-5f8bbd68f9-wcptd&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;coredns-5cfbb9f57c-ljsrl&quot;</span><span class="token plain">,</span><span class="token string" style="color:#e3116c">&quot;metrics-server-d8ccb79c9-fcvc9&quot;</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後補充 <code>.helmignore</code>，將 <code>charts</code> 打包時請考慮把敏感資料忽略，避免機密外洩。</p><p>到這邊認識了 Helm 的概念：</p><ul><li><code>Chart</code> 一個可以部署在 K8s Cluster 的檔案</li><li><code>Template</code> 組成 Kubernetes 資源</li><li><code>Values</code> Kubernetes 資源參數化</li><li><code>Release</code> Kubernetes Cluster 中部署的包</li><li><code>Push</code> 將 Chart 檔丟置倉庫</li><li><code>Install</code> 安裝一個 charts</li><li><code>Upgrade</code> 更改 Kubernetes 集群中的現有版本</li><li><code>Rollback</code> 回到以前部署的某一版本</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="總結">總結<a class="hash-link" href="#總結" title="標題的直接連結">​</a></h2><p>Helm 是一個可以解決 Kubernetes 部署資源的管理工具，但對於 <code>charts</code> 的模板在撰寫時學習曲線會比較高一些，畢竟要了解 gotemplate。而 <code>charts</code> 也應該被驗證或是掃描來提高可用性和安全性，來驗證你做了什麼和保護 <code>charts</code>。而 <code>charts</code> 另一個重要的是文件，有好的文件可以使得管理上更加輕鬆。此文章所提到的工具也不是唯一，每個團隊的使用都有自己選擇，但最後的目的都是要保護 <code>charts</code>。</p><p>另一方面，<code>charts</code> 可以被版控，也可以針對每個環境使用不同的 <code>values.yaml</code> 來做轉譯，減少了管理多環境的資源，同時對於現今的 GitOps 概念來說可以做一個很好的整合。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/cloud-native-taiwan/Infra-Labs-Docs/tree/main/docs/self-paced-labs/quarkus-with-helm-charts/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件分頁導覽"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/self-paced-labs/vault/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">Quarkus 整合 Vault KV 引擎</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#實驗環境" class="table-of-contents__link toc-highlight">實驗環境</a></li><li><a href="#建立-helm-chart" class="table-of-contents__link toc-highlight">建立 Helm Chart</a></li><li><a href="#helm-charts-整合-kubeconform" class="table-of-contents__link toc-highlight">Helm charts 整合 Kubeconform</a></li><li><a href="#helm-charts-整合-kube-score" class="table-of-contents__link toc-highlight">Helm charts 整合 kube-score</a></li><li><a href="#charts-單元測試" class="table-of-contents__link toc-highlight">charts 單元測試</a></li><li><a href="#charts-整合-helm-docs-產生文件" class="table-of-contents__link toc-highlight">charts 整合 helm-docs 產生文件</a></li><li><a href="#打包-charts-至-dockerhub" class="table-of-contents__link toc-highlight">打包 charts 至 DockerHub</a><ul><li><a href="#打包-charts" class="table-of-contents__link toc-highlight">打包 charts</a></li><li><a href="#登入-docker-hub-並推送" class="table-of-contents__link toc-highlight">登入 Docker Hub 並推送</a></li></ul></li><li><a href="#部署與操作-helm-charts" class="table-of-contents__link toc-highlight">部署與操作 Helm charts</a><ul><li><a href="#部署" class="table-of-contents__link toc-highlight">部署</a></li><li><a href="#更新-helm-chart" class="table-of-contents__link toc-highlight">更新 Helm chart</a></li><li><a href="#回滾-charts" class="table-of-contents__link toc-highlight">回滾 charts</a></li></ul></li><li><a href="#總結" class="table-of-contents__link toc-highlight">總結</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">開始使用 Openstack</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/category/基礎教學">基礎教學</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/category/進階教學">進階教學</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/faq">FAQ</a></li></ul></div><div class="col footer__col"><div class="footer__title">CNTUG 社群</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNTUG 官方網站<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://fb.cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook 社團<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram 群組<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.meetup.com/CloudNative-Taiwan/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meetup 活動<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/icon-license">Icon License</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/cloud-native-taiwan/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 CNTUG, Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.80c1bcfa.js"></script>
<script src="/assets/js/main.8f4bcb3a.js"></script>
</body>
</html>