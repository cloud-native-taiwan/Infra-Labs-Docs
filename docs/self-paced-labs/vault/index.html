<!doctype html>
<html lang="zh-Hant-TW" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-self-paced-labs/vault/index">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.2.0">
<title data-rh="true">Quarkus 整合 Vault KV 引擎 | CNTUG Infra Labs 說明文件</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs.cloudnative.tw/docs/self-paced-labs/vault/"><meta data-rh="true" name="docusaurus_locale" content="zh-Hant-TW"><meta data-rh="true" name="docsearch:language" content="zh-Hant-TW"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Quarkus 整合 Vault KV 引擎 | CNTUG Infra Labs 說明文件"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs.cloudnative.tw/docs/self-paced-labs/vault/"><link data-rh="true" rel="alternate" href="https://docs.cloudnative.tw/docs/self-paced-labs/vault/" hreflang="zh-Hant-TW"><link data-rh="true" rel="alternate" href="https://docs.cloudnative.tw/docs/self-paced-labs/vault/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CNTUG Infra Labs 說明文件 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CNTUG Infra Labs 說明文件 Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-63LPQ1DDY1"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-63LPQ1DDY1",{anonymize_ip:!0})</script><link rel="stylesheet" href="/assets/css/styles.dfb3c229.css">
<link rel="preload" href="/assets/js/runtime~main.41a420d2.js" as="script">
<link rel="preload" href="/assets/js/main.9739f520.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳至主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳至主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/cntug.png" alt="CNTUG" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/cntug.png" alt="CNTUG" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">CNTUG Infra Labs 說明文件</b></a><a class="navbar__item navbar__link" href="/intro">Intro</a><a class="navbar__item navbar__link" href="/docs/intro">Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/self-paced-labs">Labs</a><a class="navbar__item navbar__link" href="/docs/architecture/network">Architecture</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/usecase">Use Cases</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/cloud-native-taiwan/Infra-Labs-Docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="searchBox_ZlJk"></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切換淺色/暗黑模式（當前為淺色模式）" aria-label="切換淺色/暗黑模式（當前為淺色模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到頂部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/self-paced-labs">自主學習實驗室</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/network">Network</a><button aria-label="打開/收起側邊欄選單「Network」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/category/container">Container</a><button aria-label="打開/收起側邊欄選單「Container」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/category/kubernetes">Kubernetes</a><button aria-label="打開/收起側邊欄選單「Kubernetes」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/self-paced-labs/kops/">OpenStack 上利用 kops 搭建 K8S Cluster</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/self-paced-labs/kwok-in-docker/">KWOK in Docker - 體驗上千節點的 K8s 工具</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/self-paced-labs/vault/">Quarkus 整合 Vault KV 引擎</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="頁面路徑"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主頁面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/kubernetes"><span itemprop="name">Kubernetes</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Quarkus 整合 Vault KV 引擎</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><h1>Quarkus 整合 Vault KV 引擎</h1><div class="theme-admonition theme-admonition-note alert alert--secondary admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>備註</div><div class="admonitionContent_S0QG"><p>本篇文章內容與實驗會同步 <a href="https://github.com/CCH0124/quarkus-demo/tree/main/vault-demo/example/vault" target="_blank" rel="noopener noreferrer">CCH0124 - vault-demo</a></p></div></div><p>HashiCorp Vault 屬於 CNCF 的 <a href="https://landscape.cncf.io/card-mode?category=key-management&amp;grouping=category" target="_blank" rel="noopener noreferrer">Key Management</a> 類別的一員。</p><p>現今服務開發對於應用程式存取機密性資料相對都是難免，無論是在原始碼、配置檔或是其它位置。如果沒有一個機制來控管授權，想必是相當的可怕隨時都有洩漏危機。透過 Vault 可以集中管理這些機密資源，應用程式或是使用者要存取機密資源都需經過身分驗證來獲取相對應訪問資源，這樣可減少不必要的洩漏。</p><p>本文章會學習到以下</p><ul><li>安裝 Vault</li><li>使用 Vault Client 交互</li><li>使用 KV 引擎</li><li>設置 Vault Auth (Token/Kubernetes)</li><li>設置 Vault Policy</li><li>Quarkus 框架整合 Vault KV 引擎</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="實驗環境">實驗環境<a class="hash-link" href="#實驗環境" title="標題的直接連結">​</a></h2><ul><li>OS: Windows 11 WSL</li><li>Docker Engine: 23.0.5</li><li>k3d version: v5.4.9</li><li>kubectl version: v1.27.1</li><li>Helm version: v3.11.3</li><li>Vault chart version: 0.25.0</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="環境安裝與配置">環境安裝與配置<a class="hash-link" href="#環境安裝與配置" title="標題的直接連結">​</a></h2><ol><li><a href="https://docs.docker.com/engine/install/ubuntu/" target="_blank" rel="noopener noreferrer">install docker</a></li><li><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-on-linux" target="_blank" rel="noopener noreferrer">install kubectl</a></li><li><a href="https://k3d.io/v5.4.9/#install-script" target="_blank" rel="noopener noreferrer">install k3d</a></li></ol><p>安裝完 k3d 後，使用下面 k3d 配置檔案建立一個 Kubernetes 環境 :</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">## vault-conf.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> k3d.io/v1alpha4 </span><span class="token comment" style="color:#999988;font-style:italic"># this will change in the future as we make everything more stable</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Simple </span><span class="token comment" style="color:#999988;font-style:italic"># internally, we also have a Cluster config, which is not yet available externally</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">cluster </span><span class="token comment" style="color:#999988;font-style:italic"># name that you want to give to your cluster (will still be prefixed with `k3d-`)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">servers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># same as `--servers 1`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">agents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># same as `--agents 2`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kubeAPI</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># same as `--api-port myhost.my.domain:6445` (where the name would resolve to 127.0.0.1)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vault.cch.com&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># important for the `server` setting in the kubeconfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hostIP</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;127.0.0.1&quot;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># where the Kubernetes API will be listening on</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">hostPort</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;6450&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> rancher/k3s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">v1.23.14</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">k3s1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">network</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> argo</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">net</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 8050</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">80</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nodeFilters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> loadbalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 8453</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">443</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nodeFilters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> loadbalancer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">options</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">k3s</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">extraArgs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">arg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">disable=traefik</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">nodeFilters</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">*</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用 <code>k3d</code> 命令工具安裝模擬的 Kubernetes 環境，配置檔指向上述定義的檔案</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ k3d cluster create --config</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vault-conf.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>當 Kubernetes 環境被建立之後，透過 <code>kubectl config</code> 指令可以看到被建立的環境如下</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl config get-contexts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CURRENT   NAME                                                                 CLUSTER                                                              AUTHINFO                                                             NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">*         k3d-vault-cluster                                                    k3d-vault-cluster                                                    admin@k3d-vault-cluster</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="4"><li><a href="https://helm.sh/docs/intro/install/#from-apt-debianubuntu" target="_blank" rel="noopener noreferrer">Install Helm</a></li><li>Install Nginx ingress controller:</li></ol><p>在 <code>k3d</code> 上安裝 Kubernetes 時關閉了 <code>traefik</code> 選項，所以這邊用 <code>ingress-nginx</code> 取代，並使用 Helm chart 安裝，安裝步驟如下：</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ helm repo </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> ingress-nginx  https://kubernetes.github.io/ingress-nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm search repo ingress-nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> ingress-nginx ingress-nginx/ingress-nginx --version </span><span class="token number" style="color:#36acaa">4.6</span><span class="token plain">.0 --namespace ingress-nginx --create-namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get all -n ingress-nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                            READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/ingress-nginx-controller-7d5fb757db-gx8hp   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          2m36s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                         TYPE           CLUSTER-IP      EXTERNAL-IP                        PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">                      AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/ingress-nginx-controller-admission   ClusterIP      </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.138.141   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">                             </span><span class="token number" style="color:#36acaa">443</span><span class="token plain">/TCP                      2m36s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/ingress-nginx-controller             LoadBalancer   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.236.109   </span><span class="token number" style="color:#36acaa">172.19</span><span class="token plain">.0.2,172.19.0.3,172.19.0.4   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">:32369/TCP,443:31027/TCP   2m36s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/ingress-nginx-controller   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           2m36s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                                                  DESIRED   CURRENT   READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/ingress-nginx-controller-7d5fb757db   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">       2m36s</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="6"><li>Install Vault:</li></ol><p>使用 Helm chart 安裝</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">helm repo </span><span class="token function" style="color:#d73a49">add</span><span class="token plain"> hashicorp https://helm.releases.hashicorp.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">helm search repo hashicorp/vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quarkus-demo/vault-demo$ helm </span><span class="token function" style="color:#d73a49">install</span><span class="token plain"> vault hashicorp/vault --version </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain">.0 --namespace vault --create-namespace -f values/vault/values.yaml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>關於 Vault 的 <code>values.yaml</code> 安裝配置可參考我的<a href="https://raw.githubusercontent.com/CCH0124/quarkus-demo/main/vault-demo/values/vault/values.yaml" target="_blank" rel="noopener noreferrer">鏈結</a></p><p>安裝完之後必須作初始化和解封的動作，流程如下:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl --namespace vault </span><span class="token builtin class-name">exec</span><span class="token plain"> -it vault-0 -- vault operator init</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unseal Key </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">: rie1qIyzUi7hBPNkHPgI5FAni67Dwd8or8F1pK5BHGHP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unseal Key </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">: V1JTIz+PZOJRpWen8eGBu3a/f70rurWh57gF7prZTy1+</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unseal Key </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">: sbYXRQ74xQJmEC8JjoL6i5W2SzydEK81sI7fyUTX1QFW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unseal Key </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">: 4cAAitfZP5wOy6Dv/9poBuPa8r6HjJ11OYNgDcVUiFMz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Unseal Key </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">: kkEnDx8VPY3IzHMIY2zF+DntuH8W+ZhelDlK7Z6e7VIq</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Initial Root Token: hvs.3nqeHIjaG8aIMZmmBuOPSlM4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault initialized with </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> key shares and a key threshold of </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">. Please securely</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">distribute the key shares printed above. When the Vault is re-sealed,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">restarted, or stopped, you must supply at least </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> of these keys to unseal it</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">before it can start servicing requests.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Vault does not store the generated root key. Without at least </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> keys to</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reconstruct the root key, Vault will remain permanently sealed</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">It is possible to generate new unseal keys, provided you have a quorum of</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">existing unseal keys shares. See </span><span class="token string" style="color:#e3116c">&quot;vault operator rekey&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">more</span><span class="token plain"> information.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 解封，預設上至少選三個 Unseal Key</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl --namespace vault </span><span class="token builtin class-name">exec</span><span class="token plain"> -ti vault-0 -- vault operator unseal rie1qIyzUi7hBPNkHPgI5FAni67Dwd8or8F1pK5BHGHP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl --namespace vault </span><span class="token builtin class-name">exec</span><span class="token plain"> -ti vault-0 -- vault operator unseal sbYXRQ74xQJmEC8JjoL6i5W2SzydEK81sI7fyUTX1QFW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl --namespace vault </span><span class="token builtin class-name">exec</span><span class="token plain"> -ti vault-0 -- vault operator unseal kkEnDx8VPY3IzHMIY2zF+DntuH8W+ZhelDlK7Z6e7VIq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="7"><li><a href="https://developer.hashicorp.com/vault/downloads" target="_blank" rel="noopener noreferrer">Install Vault client</a></li></ol><p>要安裝的原因是不想使用 <code>kubectl exec</code> 方式進行一些配置，因此交互會從 windows WSL 環境為請求端，再透過 ingress 的入口進行存取。</p><p>在 WSL 環境中，需定義兩個環境變數 <code>VAULT_ADDR</code> 和 <code>VAULT_SKIP_VERIFY</code></p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">VAULT_ADDR</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://vault-demo.cch.com:8453</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">VAULT_SKIP_VERIFY</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>VAULT_ADDR</code> 這邊指向 Ingress 入口位置</li><li><code>VAULT_SKIP_VERIFY</code> 因為沒有完整的 SSL，所以這邊跳過驗證，但實務上不建議</li></ul><p>接著透過 <code>vault login</code> 登入，這邊登入的 <code>token</code> 是使用上個步驟的初始 Vault 時產生的 Root Token。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault login -tls-skip-verify hvs.3nqeHIjaG8aIMZmmBuOPSlM4 </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊必須要能夠登入，才能往下進行。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="kv-secrets-engine---version-2">KV secrets engine - version 2<a class="hash-link" href="#kv-secrets-engine---version-2" title="標題的直接連結">​</a></h2><p>在啟用版本 2 的 <code>KV</code> 引擎時，必須透過 <code>secret</code> 引擎啟用。<code>secret</code> 引擎是一個儲存、生成或是加密數據的組件。版本 2 的 <code>KV</code> 引擎是一個可存取 key/value 對的功能，並且附帶過去每次異動版本歷程，因此舊的配置是可以被檢索的，下圖為官方提供的圖。</p><p><img loading="lazy" src="https://developer.hashicorp.com/_next/image?url=https%3A%2F%2Fcontent.hashicorp.com%2Fapi%2Fassets%3Fproduct%3Dtutorials%26version%3Dmain%26asset%3Dpublic%252Fimg%252Fvault%252Fversioned-kv-1.png%26width%3D1056%26height%3D353&amp;w=1080&amp;q=75" class="img_ev3q"></p><p>對於應用程式存取而言，必須要先啟用 <code>KV</code> 功能。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault secrets </span><span class="token builtin class-name">enable</span><span class="token plain"> -version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> kv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Enabled the kv secrets engine at: kv/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>透過 <code>list</code> 指令可以列出我們創建的 <code>KV</code> 路徑引擎</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault secrets list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path          Type         Accessor              Description</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----          ----         --------              -----------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cubbyhole/    cubbyhole    cubbyhole_293822d8    per-token private secret storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">identity/     identity     identity_5bba97e7     identity store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kv/           kv           kv_cd1f8bda           n/a </span><span class="token comment" style="color:#999988;font-style:italic"># 這是被啟用的 KV 引擎，路徑是 kv</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sys/          system       system_6e9e02ef       system endpoints used </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> control, policy and debugging</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="建立給應用程式的-kv-對">建立給應用程式的 KV 對<a class="hash-link" href="#建立給應用程式的-kv-對" title="標題的直接連結">​</a></h3><p>Quarkus 範例會定義 <code>mqtt.broker</code>、<code>mqtt.username</code> 和 <code>mqtt.password</code> 三個環境變數，最後目標是可以透過 API 介面來獲取從 Vault 儲存的值。</p><p>下面使用 <code>kv put</code> 將值定義至 Vault 中。在 Vault 的 <code>KV</code> 引擎中，它類似以資料夾結構為概念去建立路徑。在此範例中，會在 <code>kv</code> 路徑下建立一個 <code>quarkus/vault-demo</code> 路徑，並塞入我們要給應用程式的值。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv put kv/quarkus/vault-demo mqtt.broker</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;tcp://localhost:8883&quot;</span><span class="token plain"> mqtt.username</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;demo&quot;</span><span class="token plain"> mqtt.password</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;demo1234&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Secret Path </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kv/data/quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Metadata </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time       </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:33:34.390315381Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_metadata    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deletion_time      n/a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destroyed          </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version            </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>建立後，可以透過 <code>kv get</code> 來獲取某路徑下已經定義的鍵值對。<code>version</code> 為 1，是因為我們推送了一次值。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv get -mount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Secret Path </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kv/data/quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Metadata </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time       </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:33:34.390315381Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_metadata    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deletion_time      n/a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destroyed          </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 上步驟推資料所以異動一次</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 下面為推送的鍵值對</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Data </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key              Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---              -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.broker      tcp://localhost:8883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.password    demo1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.username    demo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果資料定義錯誤想要做修正可以使用 <code>kv patch</code> 指令，假設 <code>mqtt.password</code> 設定錯誤要換成 demo12345678。這時又對資料進行了異動因此 <code>version</code>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv patch -mount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv quarkus/vault-demo mqtt.password</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">demo12345678</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Secret Path </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kv/data/quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Metadata </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time       </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:41:39.647900006Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_metadata    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deletion_time      n/a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destroyed          </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version            </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 此時更新密碼因此版本在被遞增</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>更新後，再使用 <code>kv get</code> 時該 <code>mqtt.password</code> 應當是被置換過值。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="檢索特定版本">檢索特定版本<a class="hash-link" href="#檢索特定版本" title="標題的直接連結">​</a></h3><p>如果想查看過去異動，或是更新前的查看都可以使用 <code>version</code> 來進行。在前面的過程中版本已經遞增至 2。如果想回頭看 1 的版本，可以如下</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv get -version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> -mount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Secret Path </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kv/data/quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Metadata </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time       </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:33:34.390315381Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_metadata    </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deletion_time      n/a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destroyed          </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">version            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Data </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key              Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---              -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.broker      tcp://localhost:8883</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.password    demo1234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.username    demo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>預設上版本 2 的 <code>KV</code> 引擎 <code>Maximum number of versions</code> 是未設定，如下使用 <code>read</code> 指令查詢可獲取其配置。但可以依照需求去做調整。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault </span><span class="token builtin class-name">read</span><span class="token plain"> kv/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                     Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                     -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cas_required            </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delete_version_after    0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_versions            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="刪除與復原版本">刪除與復原版本<a class="hash-link" href="#刪除與復原版本" title="標題的直接連結">​</a></h3><p>對於 Vault 中 <code>delete</code> 動作是軟刪除，該版本會被標記是刪除且定義一個 <code>deletion_time</code> 時戳，這可用於 <code>undelete</code> 操作基本上可以認知成回滾。當 <code>KV</code> 版本超過 <code>max-versions</code> 設置的數量時，或者使用 <code>destroy</code> 操作時，版本的數據才會被永久刪除。</p><p>刪除版本 1</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv delete -versions</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> -mount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Data deleted </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">if it existed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> at: kv/data/quarkus/vault-demo</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>刪除後，使用 <code>metadata</code> 操作獲取詳細版本資訊。<code>Version 1</code> 刪除後被定義了 <code>deletion_time</code>，表示不會被立即移除。此時注意 <code>Version 2</code> 因為沒做 <code>delete</code> 動作因此 <code>deletion_time</code> 沒被定義。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv metadata get  -mount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Metadata Path </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kv/metadata/quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Metadata </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                     Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                     -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cas_required            </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time            </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:33:34.390315381Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">current_version         </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">custom_metadata         </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">delete_version_after    0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_versions            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">oldest_version          </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">updated_time            </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:41:39.647900006Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Version </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key              Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---              -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time     </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:33:34.390315381Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deletion_time    </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T17:12:50.563260118Z </span><span class="token comment" style="color:#999988;font-style:italic"># deletion_time 被定義，表示不會被立即移除</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destroyed        </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Version </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key              Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---              -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time     </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:41:39.647900006Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deletion_time    n/a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destroyed        </span><span class="token boolean" style="color:#36acaa">false</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>嘗試復原版本 1，注意到 <code>deletion_time</code> 欄位時戳被設置為 <code>n/a</code>。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv undelete -versions</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> -mount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Data written to: kv/undelete/quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ vault kv metadata get  -mount</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Metadata Path </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kv/metadata/quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> Version </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token operator" style="color:#393A34">==</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key              Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---              -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">created_time     </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-12T14:33:34.390315381Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deletion_time    n/a </span><span class="token comment" style="color:#999988;font-style:italic"># 要被刪除時間已經設回原始</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">destroyed        </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>至於 <code>destroy</code> 操作，不接續展示基本上是會直接將指定版本資源刪除，不做任何標記。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="定義訪問-quarkusvault-demo-的角色">定義訪問 quarkus/vault-demo 的角色<a class="hash-link" href="#定義訪問-quarkusvault-demo-的角色" title="標題的直接連結">​</a></h2><p>以此範例來說應用程式只想要讀取 <code>quarkus/vault-demo</code> 這個路徑下的資源，因此要給予適當權限，同時減少攻擊面。下面定義了一個政策的檔案，針對這 <code>kv/data/quarkus/vault-demo</code> 路徑只給予讀(read)權限。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># policy.hcl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">path </span><span class="token string" style="color:#e3116c">&quot;kv/data/quarkus/vault-demo&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    capabilities </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;read&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>如果將 <code>path</code> 定義 <code>kv/data/quarkus/+</code> 其實也是可以的，就看應用方面到哪裡。<code>+</code> 表示當下同層路徑都可存取 </p><ul><li>kv/data/quarkus/a</li><li>kv/data/quarkus/b</li></ul><p>但是下面是無法被存取</p><ul><li>kv/data/quarkus/a/a</li></ul><p>將上述 <code>policy.hcl</code> 寫入 Vault 中，透過 <code>policy write</code> 指令。建立之後，透過 <code>policy list</code> 可以查看是否被建立。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault policy </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> vault policy.hcl</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Uploaded policy: vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ vault policy list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vault </span><span class="token comment" style="color:#999988;font-style:italic"># 建立的 policy 名稱是 vault</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">root</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>當然這樣定義了權限還不夠，因為它沒被綁定到某個主題可能是一個 <code>token</code> 服務或是 <code>user/pass</code> 服務。截至當前都是使用 <code>root</code> 的 <code>token</code> 做操作，應用程式的存取不應該使用 <code>root</code> 權限進行操作，因此需要再定義一個屬於應用程式存取的 <code>token</code>。</p><p>透過 <code>token create</code> 建立一個 <code>token</code> 如下，並賦予該有的權限，時效可用 <code>ttl</code> 設定。<code>token lookup</code> 可以查看該 <code>token</code> 內容，像是過期時間(expire_time)、可存取的政策(policies)等等。<code>-policy</code> 綁定了上步驟被定義為 <code>vault</code> 的政策，應用程式範例將使用此 <code>token</code> 進行存取。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault token create -policy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vault --ttl</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">768h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                  Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                  -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token                hvs.CAESIIDXLAV0-_yh1VJjVQkDxojDEP54lTfT0Y-UsVEBJKBhGh4KHGh2cy5lRFRMeFpBSmpGMGo2ZXRNR0RsTDh3UmI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_accessor       KqbfPMrF6pmmFLb4n7E1niob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_duration       768h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_renewable      </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_policies       </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vault&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">identity_policies    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">policies             </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;default&quot;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;vault&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ vault token lookup -accessor KqbfPMrF6pmmFLb4n7E1niob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                 Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                 -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">accessor            KqbfPMrF6pmmFLb4n7E1niob</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">creation_time       </span><span class="token number" style="color:#36acaa">1692449442</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">creation_ttl        768h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">display_name        token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">entity_id           n/a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">expire_time         </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-09-20T12:50:42.985961541Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">explicit_max_ttl    0s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">id</span><span class="token plain">                  n/a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">issue_time          </span><span class="token number" style="color:#36acaa">2023</span><span class="token plain">-08-19T12:50:42.985964311Z</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">meta                </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">nil</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_uses            </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">orphan              </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">path                auth/token/create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">policies            </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">default vault</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">renewable           </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ttl                 767h59m36s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">type</span><span class="token plain">                </span><span class="token function" style="color:#d73a49">service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>對於 <code>token</code> 預設系統 <code>TTL</code> 值是 <code>768h</code> 如下。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault </span><span class="token builtin class-name">read</span><span class="token plain"> sys/auth/token/tune</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key                  Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---                  -----</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_lease_ttl    768h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">description          token based credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">force_no_cache       </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_lease_ttl        768h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_type           default-service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>要針對 <code>TTL</code> 進行調整可以使用以下方式，這邊要調整的話當下登入者必須有足夠權限。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> sys/auth/token/tune </span><span class="token assign-left variable" style="color:#36acaa">default_lease_ttl</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">8h </span><span class="token assign-left variable" style="color:#36acaa">max_lease_ttl</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">720h</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="quarkus-整合-vault">Quarkus 整合 Vault<a class="hash-link" href="#quarkus-整合-vault" title="標題的直接連結">​</a></h2><p>上面章節透過 Vault 的 <code>KV</code> 給服務建立一個可存放機密物件的資源並將重要的資源存放至該路徑上。同時間，也建立了一個 <code>policy</code> 資源並將其和 <code>token</code> 資源綁在一起給應用程式做存取。</p><p>此章節會透過 Quarkus 框架與 Vault 進行一個整合範例。會分成兩部分來說明</p><ol><li>地端開發</li><li>佈署至 Kubernetes 環境</li></ol><p>Quarkus 使用 <code>io.quarkiverse.vault:quarkus-vault</code> 第三方套件整合 Vault，接續將會實作整合部分。範例中簡單的使用外部環境變數，如下</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.broker=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.username=</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mqtt.password=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這些值在上面章節已經完成放置 Vault 服務。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="地端開發">地端開發<a class="hash-link" href="#地端開發" title="標題的直接連結">​</a></h3><p>這邊再進行 Vault 存取的配置來讓 Vault 進行環境變數的注入。因為 SSL 非正式所以這邊使用了 <code>quarkus.tls.trust-all=true</code> 來進行信任。重點是下面配置</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">%dev.quarkus.vault.authentication.client-token</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">hvs.CAESIIDXLAV0-_yh1VJjVQkDxojDEP54lTfT0Y-UsVEBJKBhGh4KHGh2cy5lRFRMeFpBSmpGMGo2ZXRNR0RsTDh3UmI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quarkus.vault.url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://vault-demo.cch.com:8453</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quarkus.vault.kv-secret-engine-mount-path</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">kv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quarkus.vault.secret-config-kv-path</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">quarkus/vault-demo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">quarkus.vault.kv-secret-engine-version</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><code>quarkus.vault.authentication.client-token</code> 表示使用 token 方式對 Vault 進行存取</li><li><code>quarkus.vault.url</code> 表示存取 Vault 的位置</li><li><code>quarkus.vault.kv-secret-engine-mount-path</code> 啟用 secret 中的 kv 引擎掛載的路徑</li><li><code>quarkus.vault.secret-config-kv-path</code> 掛載路徑下要存取的子路徑</li><li><code>quarkus.vault.kv-secret-engine-version</code> 使用的版本，預設是 2</li></ol><p>這邊的 <code>%dev</code> 是指在 dev 環境使用該值。</p><p>驗證方面，寫了一個 API 接口，透過該接口可以驗證是否從 Vault 的 <code>KV</code> 獲取資源</p><div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    @GET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Path(&quot;/mqtt/config&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Produces(MediaType.APPLICATION_JSON)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public Response config() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return Response.ok(Map.of(&quot;url&quot;, mqttConnect.broker())).build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最後運行應用程式，嘗試存取 <code>/hello/mqtt/config</code> 接口如下，可以看出他確實拿到了資源。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://localhost:8080/hello/mqtt/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;url&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;tcp://localhost:8883&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>對於地端來說雖然 <code>quarkus.vault.authentication.client-token</code> 的值已經有限制權限和時效，但還是會習慣把 <code>quarkus.vault.authentication.client-token</code> 放置 .env 檔案中，這樣基本上原始碼不會出現關於存取 Vault 服務可存取 API 的 <code>toekn</code> 資源。</p><p>程式碼可參考我的<a href="https://github.com/CCH0124/quarkus-demo/tree/ef9e04122d4acb1ac2920d17322c23e924422c2b/vault-demo/example/vault" target="_blank" rel="noopener noreferrer">鏈結</a></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="kubernetes-環境">Kubernetes 環境<a class="hash-link" href="#kubernetes-環境" title="標題的直接連結">​</a></h3><p>對於佈署至 Kubernetes 環境，Vault 提供了用 <code>serviceAccount</code> 的 <code>token</code> 存取 Vault 服務的功能。相較於使用上面 <code>token</code> 方式，會比較靈活很多，我會認為不必特別管理 <code>token</code> 是否會過期，或是管理多個 <code>token</code>。</p><p>要使用 Kubernetes 認證必須執行以下，這邊會使用 root 權限進行操作</p><ol><li>啟用該功能</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault auth </span><span class="token builtin class-name">enable</span><span class="token plain"> kubernetes</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Enabled kubernetes auth method at: kubernetes/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol start="2"><li>用 <code>/config</code> 介面配置 Vault 與 Kubernetes 的通訊，使用 Pod 的 <code>serviceAccount</code> 的 <code>token</code>。 Vault 將定期重新讀取該檔案以支援短期令牌(short-lived tokens)。這樣 Vault 將嘗試從預設掛載位置 <code>/var/run/secrets/kubernetes.io/serviceaccount/</code> 內的 <code>token</code> 和 <code>ca.crt</code> 加載它們。</li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> auth/kubernetes/config </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token assign-left variable" style="color:#36acaa">kubernetes_host</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">https://</span><span class="token variable" style="color:#36acaa">$KUBERNETES_SERVICE_HOST</span><span class="token builtin class-name">:</span><span class="token variable" style="color:#36acaa">$KUBERNETES_SERVICE_PORT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Data written to: auth/kubernetes/config</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>$KUBERNETES_SERVICE_HOST</code> 與 <code>$KUBERNETES_SERVICE_PORT</code> 是環境變數，需替代真實的值，本人測試時環境變數似乎無法被系統替代。</p><ol start="3"><li>設定允許被存取的 <code>namespace</code> 與 <code>serviceAccount</code></li></ol><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vault </span><span class="token function" style="color:#d73a49">write</span><span class="token plain"> auth/kubernetes/role/quarkus-vault </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">bound_service_account_names</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vault </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">bound_service_account_namespaces</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">prod </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">policies</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">vault </span><span class="token punctuation" style="color:#393A34">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token assign-left variable" style="color:#36acaa">ttl</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">1h</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Success</span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> Data written to: auth/kubernetes/role/quarkus-vault</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>quarkus-vault</code> 是角色名稱，應用程式存取用此角色</li><li><code>bound_service_account_names</code> 可使用該角色的 <code>serviceAccout</code></li><li><code>bound_service_account_namespaces</code> 可使用該角色的 <code>namespace</code></li><li><code>policies</code> 該角色綁定的政策，這邊會對應上面所設定的政策</li></ul><p>Vault 中一個角色能被 kubernetes 中的 namespace 下的多個 serviceAccount 資源共同所使用，政策同樣也可以綁定多個。</p><p>當設定好之後，在 Quarkus 專案中的 <code>application.properties</code> 檔案定義以下，表示在 prod 環境中使用以下定義的值。</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">%prod.quarkus.vault.url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">http://vault.vault.svc.cluster.local:8200</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">%prod.quarkus.vault.authentication.kubernetes.role</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">quarkus-vault</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接著嘗試佈署我們的應用程式至 k3d 模擬的 Kubernetes 環境，下面是部分 deployment.yaml 檔案內容詳細可參考此<a href="https://raw.githubusercontent.com/CCH0124/quarkus-demo/main/vault-demo/example/vault/kubernetes/deployment.yaml" target="_blank" rel="noopener noreferrer">鏈結</a>。</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># deployment.yaml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> apps/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Deployment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/managed-by</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quarkus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.0.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/part-of</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">replicas</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">selector</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">matchLabels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.0.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/part-of</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">template</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/managed-by</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quarkus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.0.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/part-of</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">containers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">env</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> KUBERNETES_NAMESPACE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">valueFrom</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">fieldRef</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">fieldPath</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metadata.namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> registry.hub.docker.com/cch0124/vault</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">788ed52</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token key atrule" style="color:#00a4db">imagePullPolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">securityContext</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">fsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">runAsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">runAsNonRoot</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">runAsUser</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">185</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">serviceAccountName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">apiVersion</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> networking.k8s.io/v1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ingress</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">metadata</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">annotations</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nginx.ingress.kubernetes.io/rewrite-target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /$2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">labels</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/part-of</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/version</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 1.0.0</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">SNAPSHOT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">app.kubernetes.io/managed-by</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> quarkus</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spec</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ingressClassName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nginx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">rules</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">demo.cch.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">http</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">paths</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">backend</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> vault</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> http</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /api/v1(/</span><span class="token punctuation" style="color:#393A34">|</span><span class="token plain">$)(.</span><span class="token important">*)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token key atrule" style="color:#00a4db">pathType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Prefix</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>接著透過佈署 deployment.yaml 測試，應用程式佈署資源如下</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vault-demo/example/vault/kubernetes$ kubectl apply -f deployment.yaml</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get all -n prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                         READY   STATUS    RESTARTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pod/vault-76cfcb466f-s6z2m   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">          6m15s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">S</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service/vault   ClusterIP   </span><span class="token number" style="color:#36acaa">10.43</span><span class="token plain">.236.207   </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">none</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">        </span><span class="token number" style="color:#36acaa">8080</span><span class="token plain">/TCP   34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">deployment.apps/vault   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">/1     </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">            </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">           34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME                               DESIRED   CURRENT   READY   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">replicaset.apps/vault-76cfcb466f   </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">         </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">       34m</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ kubectl get ingress -n prod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME    CLASS   HOSTS                ADDRESS                            PORTS   AGE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vault   nginx   vault-demo.cch.com   </span><span class="token number" style="color:#36acaa">172.18</span><span class="token plain">.0.2,172.18.0.3,172.18.0.4   </span><span class="token number" style="color:#36acaa">80</span><span class="token plain">      35m</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>測試，確實那到了 <code>KV</code> 上定義的值</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ </span><span class="token function" style="color:#d73a49">curl</span><span class="token plain"> http://vault-demo.cch.com:8050/api/v1/hello/mqtt/config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;url&quot;</span><span class="token builtin class-name">:</span><span class="token string" style="color:#e3116c">&quot;tcp://localhost:8883&quot;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="複製代碼至剪貼簿" title="複製" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>這邊，應用程式透過了 Vault 中 kubernete 認證方式對 Vault 進行存取，而非 <code>token</code> 認證。整體的流程會如下圖所示</p><p><img loading="lazy" src="/assets/images/vau_k8s_auth_flow-aa78c99285897340fdf1f9441f96cb84.png" width="987" height="579" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="總結">總結<a class="hash-link" href="#總結" title="標題的直接連結">​</a></h2><p>Vault 在應用上可以集中式管理機密資源，加上需要透過認證才能去存取資源基本上攻擊面或是洩漏資訊可能性少了很多。此篇文章透過了框架對 Vault 資源進行整合，其使用對開發者來說也是輕鬆。但對於應用程式存取 Vault 除了透過框架提供的方式，還可以使用 Vault 的 <code>sidecar</code> 方式或是 CSI (Container Storage Interface) 整合，如果是對於遺留較久的專案可以考慮這種方式。</p><p>但如果服務多的話，對於 Vault 上的 <code>path</code> 設計其實也是很重要的一環，不應當所有服務都對一個路徑下的 <code>KV</code> 進行存取。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/cloud-native-taiwan/Infra-Labs-Docs/tree/main/docs/self-paced-labs/vault/index.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>編輯此頁</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件分頁導覽"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/self-paced-labs/kwok-in-docker/"><div class="pagination-nav__sublabel">上一頁</div><div class="pagination-nav__label">KWOK in Docker - 體驗上千節點的 K8s 工具</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#實驗環境" class="table-of-contents__link toc-highlight">實驗環境</a></li><li><a href="#環境安裝與配置" class="table-of-contents__link toc-highlight">環境安裝與配置</a></li><li><a href="#kv-secrets-engine---version-2" class="table-of-contents__link toc-highlight">KV secrets engine - version 2</a><ul><li><a href="#建立給應用程式的-kv-對" class="table-of-contents__link toc-highlight">建立給應用程式的 KV 對</a></li><li><a href="#檢索特定版本" class="table-of-contents__link toc-highlight">檢索特定版本</a></li><li><a href="#刪除與復原版本" class="table-of-contents__link toc-highlight">刪除與復原版本</a></li></ul></li><li><a href="#定義訪問-quarkusvault-demo-的角色" class="table-of-contents__link toc-highlight">定義訪問 quarkus/vault-demo 的角色</a></li><li><a href="#quarkus-整合-vault" class="table-of-contents__link toc-highlight">Quarkus 整合 Vault</a><ul><li><a href="#地端開發" class="table-of-contents__link toc-highlight">地端開發</a></li><li><a href="#kubernetes-環境" class="table-of-contents__link toc-highlight">Kubernetes 環境</a></li></ul></li><li><a href="#總結" class="table-of-contents__link toc-highlight">總結</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">開始使用 Openstack</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/category/基礎教學">基礎教學</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/category/進階教學">進階教學</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/faq">FAQ</a></li></ul></div><div class="col footer__col"><div class="footer__title">CNTUG 社群</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">CNTUG 官方網站<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://fb.cloudnative.tw/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Facebook 社團<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://t.me/cntug" target="_blank" rel="noopener noreferrer" class="footer__link-item">Telegram 群組<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.meetup.com/CloudNative-Taiwan/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meetup 活動<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/icon-license">Icon License</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/cloud-native-taiwan/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 CNTUG, Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.41a420d2.js"></script>
<script src="/assets/js/main.9739f520.js"></script>
</body>
</html>